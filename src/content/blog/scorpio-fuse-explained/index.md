---
title: "Scorpioï¼šåŸºäº FUSE çš„ Monorepo è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ"
description: "ç³»ç»Ÿæ‹†è§£ Mega é¡¹ç›®ä¸­çš„ Scorpio æ¨¡å—ï¼šFUSE åŸç†ã€Overlay åˆ†å±‚è®¾è®¡ã€æŒ‰éœ€åŠ è½½çš„å®ç°ï¼Œä»¥åŠé¢å‘ CI/CD çš„ Antares æ„å»ºéš”ç¦»æ–¹æ¡ˆã€‚"
publishDate: "2025-12-11"
tags: ["FUSE", "Monorepo", "Mega", "Scorpio", "æ–‡ä»¶ç³»ç»Ÿ"]
language: "zh-CN"
draft: false
---

> æœ¬æ–‡å°è¯•ç³»ç»Ÿæ‹†è§£ Mega é¡¹ç›®ä¸­çš„ Scorpio æ¨¡å—ï¼šä» FUSE çš„åŸºæœ¬åŸç†ï¼Œåˆ° Overlay æ–‡ä»¶ç³»ç»Ÿçš„åˆ†å±‚è®¾è®¡ï¼Œçœ‹çœ‹å¦‚ä½•ç”¨ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿå®ç°ä¸€ä¸ªæŒ‰éœ€åŠ è½½çš„ monorepo æŒ‚è½½æ–¹æ¡ˆã€‚

## ä¸€ã€èƒŒæ™¯ï¼šä¸ºä»€ä¹ˆéœ€è¦ Scorpioï¼Ÿ

åœ¨å¤§å‹ monorepo åœºæ™¯ä¸‹ï¼Œå¼€å‘è€…ç»å¸¸ä¼šé‡åˆ°ä¸€ä¸ªä¸¤éš¾é€‰æ‹©ï¼š

- **å®Œæ•´å…‹éš†**ï¼šä»“åº“ä½“ç§¯å¯èƒ½è¾¾åˆ°å‡ å GBï¼Œ`git clone` éœ€è¦è€—è´¹å¤§é‡æ—¶é—´å’Œç£ç›˜ç©ºé—´
- **ç¨€ç–æ£€å‡º**ï¼šé…ç½®å¤æ‚ï¼Œå¯¹ç›®å½•ç»“æ„å˜åŒ–ä¸å¤Ÿå‹å¥½ï¼Œéš¾ä»¥åŠ¨æ€æ‰©å±•å·¥ä½œé›†

Scorpio æä¾›äº†ç¬¬ä¸‰æ¡è·¯ï¼š**é€šè¿‡è™šæ‹Ÿæ–‡ä»¶ç³»ç»ŸæŒ‚è½½è¿œç¨‹ä»“åº“**ã€‚

å®ƒçš„ç›®æ ‡å½¢æ€æ˜¯ï¼š

- ä»“åº“è¢«"æŒ‚è½½"åˆ°æœ¬åœ°æŸä¸ªç›®å½•
- åˆå§‹åªæ‹‰å–ç›®å½•æ ‘å’Œå¿…è¦å…ƒæ•°æ®
- æ–‡ä»¶åœ¨ç¬¬ä¸€æ¬¡è®¿é—®æ—¶å†æŒ‰éœ€ä¸‹è½½
- æœ¬åœ°ä¿®æ”¹ä»ç„¶å¯ä»¥æ­£å¸¸ç‰ˆæœ¬æ§åˆ¶å’Œæäº¤

ç²—ç•¥å¯¹æ¯”ä¸€ä¸‹å·¥ä½œæµï¼š

```text
ä¼ ç»Ÿæ–¹å¼ï¼šgit clone (ä¸‹è½½å…¨éƒ¨) â†’ æœ¬åœ°æ“ä½œ â†’ git push
Scorpioï¼š mount (ä¸‹è½½ç›®å½•æ ‘) â†’ æŒ‰éœ€åŠ è½½ â†’ æœ¬åœ°æ“ä½œ â†’ commit & push
```

è¦å®ç°è¿™ç§è¡Œä¸ºï¼Œå…³é”®æ˜¯ **FUSEï¼ˆFilesystem in Userspaceï¼‰**ã€‚

---

## äºŒã€FUSE åŸç†ç®€è¿°

### 2.1 ä»€ä¹ˆæ˜¯ FUSEï¼Ÿ

FUSE æ˜¯ä¸€ä¸ªå…è®¸åœ¨ç”¨æˆ·æ€å®ç°æ–‡ä»¶ç³»ç»Ÿé€»è¾‘çš„æ¡†æ¶ã€‚

- ä¼ ç»Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆext4ã€NTFS ç­‰ï¼‰è¿è¡Œåœ¨å†…æ ¸ç©ºé—´ï¼Œå¼€å‘å’Œè°ƒè¯•é—¨æ§›è¾ƒé«˜
- FUSE æŠŠã€Œåè®®ã€ç•™åœ¨å†…æ ¸é‡Œï¼ŒæŠŠã€Œå…·ä½“è¯»å†™é€»è¾‘ã€æ¬åˆ°äº†ç”¨æˆ·æ€è¿›ç¨‹ä¸­

è¿™ç»™äº†æˆ‘ä»¬ä¸€ä¸ªæœºä¼šï¼š**ç”¨æ™®é€šç”¨æˆ·æ€è¿›ç¨‹çš„æ–¹å¼å®ç°è‡ªå®šä¹‰æ–‡ä»¶ç³»ç»Ÿ**ï¼Œä¾‹å¦‚ï¼š

- sshfsï¼ˆè¿œç¨‹ç›®å½•æŒ‚è½½ï¼‰
- rcloneï¼ˆäº‘å­˜å‚¨æŒ‚è½½ï¼‰
- ä»¥åŠæœ¬æ–‡è®¨è®ºçš„ Scorpio

### 2.2 FUSE æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ç”¨æˆ·ç©ºé—´ (User Space)                        â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚ Application â”‚         â”‚     FUSE Daemon (ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿ)      â”‚     â”‚
â”‚   â”‚  (ls, cat)  â”‚         â”‚                                      â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚     â”‚
â”‚          â”‚                â”‚  â”‚  å®ç° read/write/lookup ç­‰    â”‚   â”‚     â”‚
â”‚          â”‚ open/read      â”‚  â”‚  ä¾‹å¦‚: Scorpio, sshfs, rclone â”‚   â”‚     â”‚
â”‚          â”‚                â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚     â”‚
â”‚          â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                   â”‚
           â”‚ syscall                           â”‚ /dev/fuse
           â–¼                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å†…æ ¸ç©ºé—´ (Kernel Space)                       â”‚
â”‚                                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   â”‚     VFS     â”‚ â”€â”€â”€â–º â”‚ FUSE Kernel  â”‚ â”€â”€â”€â–º â”‚   /dev/fuse     â”‚        â”‚
â”‚   â”‚ (è™šæ‹Ÿæ–‡ä»¶   â”‚      â”‚   Module     â”‚      â”‚ (å­—ç¬¦è®¾å¤‡)       â”‚        â”‚
â”‚   â”‚  ç³»ç»Ÿå±‚)    â”‚      â”‚              â”‚      â”‚                 â”‚        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 FUSE è¯·æ±‚å¤„ç†æµç¨‹

ä»¥ `cat /mnt/fuse/file.txt` ä¸ºä¾‹ï¼š

```text
1. åº”ç”¨ç¨‹åºè°ƒç”¨ open("/mnt/fuse/file.txt", O_RDONLY)
                    â”‚
                    â–¼
2. ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸ VFS å±‚
                    â”‚
                    â–¼
3. VFS å‘ç°æŒ‚è½½ç‚¹å±äº FUSEï¼Œè½¬å‘è¯·æ±‚åˆ° FUSE å†…æ ¸æ¨¡å—
                    â”‚
                    â–¼
4. FUSE å†…æ ¸æ¨¡å—å°†è¯·æ±‚åºåˆ—åŒ–ï¼Œå†™å…¥ /dev/fuse
                    â”‚
                    â–¼
5. ç”¨æˆ·æ€ FUSE å®ˆæŠ¤è¿›ç¨‹ä» /dev/fuse è¯»å–è¯·æ±‚
                    â”‚
                    â–¼
6. å®ˆæŠ¤è¿›ç¨‹å¤„ç†è¯·æ±‚ï¼ˆå¦‚ä»ç½‘ç»œè·å–æ–‡ä»¶å†…å®¹ï¼‰
                    â”‚
                    â–¼
7. å®ˆæŠ¤è¿›ç¨‹å°†å“åº”å†™å› /dev/fuse
                    â”‚
                    â–¼
8. FUSE å†…æ ¸æ¨¡å—å°†å“åº”è¿”å›ç»™ VFS
                    â”‚
                    â–¼
9. åº”ç”¨ç¨‹åºæ”¶åˆ° open() çš„è¿”å›å€¼
```

### 2.4 FUSE æ ¸å¿ƒæ“ä½œ

FUSE è¦æ±‚å®ç°ä¸€ç»„åŸºç¡€æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼Œå¯¹åº”åˆ°å¸¸è§ç³»ç»Ÿè°ƒç”¨ï¼š

| æ“ä½œ | æè¿° | å¯¹åº”ç³»ç»Ÿè°ƒç”¨ |
|------|------|--------------|
| `lookup` | æŸ¥æ‰¾ç›®å½•é¡¹ | `stat`, `access` |
| `getattr` | è·å–æ–‡ä»¶å±æ€§ | `stat`, `fstat` |
| `readdir` | è¯»å–ç›®å½•å†…å®¹ | `readdir`, `getdents` |
| `open` | æ‰“å¼€æ–‡ä»¶ | `open` |
| `read` | è¯»å–æ–‡ä»¶å†…å®¹ | `read`, `pread` |
| `write` | å†™å…¥æ–‡ä»¶å†…å®¹ | `write`, `pwrite` |
| `create` | åˆ›å»ºæ–‡ä»¶ | `creat`, `open(O_CREAT)` |
| `mkdir` | åˆ›å»ºç›®å½• | `mkdir` |
| `unlink` | åˆ é™¤æ–‡ä»¶ | `unlink`, `remove` |
| `rename` | é‡å‘½å | `rename` |

### 2.5 Rust ä¸­çš„ FUSE å®ç°

Scorpio ä½¿ç”¨çš„æ˜¯ `rfuse3` åº“ï¼Œæä¾›äº†å¼‚æ­¥ FUSE æ”¯æŒã€‚å®ç°ä¸Šå°±æ˜¯åœ¨ä¸€ä¸ª trait é‡ŒæŠŠè¿™äº›æ“ä½œè¡¥å…¨ï¼š

```rust
use rfuse3::raw::{Filesystem, Request};

impl Filesystem for MyFS {
    async fn lookup(&self, req: Request, parent: u64, name: &OsStr) -> Result<ReplyEntry> {
        // æŸ¥æ‰¾ parent ç›®å½•ä¸‹åä¸º name çš„æ–‡ä»¶
        // è¿”å›æ–‡ä»¶çš„ inode å’Œå±æ€§
    }

    async fn read(&self, req: Request, ino: u64, offset: i64, size: u32) -> Result<ReplyData> {
        // è¯»å– inode ä¸º ino çš„æ–‡ä»¶ï¼Œä» offset å¼€å§‹è¯»å– size å­—èŠ‚
    }

    async fn write(&self, req: Request, ino: u64, offset: i64, data: &[u8]) -> Result<ReplyWrite> {
        // å°† data å†™å…¥åˆ° inode ä¸º ino çš„æ–‡ä»¶çš„ offset ä½ç½®
    }
}
```

---

## ä¸‰ã€FUSE è¿›é˜¶ä¸»é¢˜

å‰é¢ä»‹ç»äº† FUSE çš„åŸºæœ¬å·¥ä½œåŸç†ï¼Œè¿™ä¸€èŠ‚æˆ‘ä»¬æ·±å…¥æ¢è®¨åè®®ç»†èŠ‚ã€æ€§èƒ½å±€é™ä»¥åŠä¸åŒå®ç°åº“çš„å·®å¼‚ã€‚

### 3.1 FUSE åè®®ç»†èŠ‚

#### FUSE_INITï¼šæ¡æ‰‹ä¸èƒ½åŠ›åå•†

FUSE ä¼šè¯ä» `FUSE_INIT` å¼€å§‹ï¼Œå†…æ ¸ä¸ç”¨æˆ·æ€å®ˆæŠ¤è¿›ç¨‹é€šè¿‡è¿™ä¸ªæ¶ˆæ¯åå•†åè®®ç‰ˆæœ¬å’Œæ”¯æŒçš„åŠŸèƒ½ï¼š

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FUSE Kernel   â”‚                    â”‚   FUSE Daemon   â”‚
â”‚     Module      â”‚                    â”‚   (Scorpio)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                      â”‚
         â”‚  FUSE_INIT request                   â”‚
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
         â”‚  â”‚ major: 7                    â”‚     â”‚
         â”‚  â”‚ minor: 38                   â”‚     â”‚
         â”‚  â”‚ max_readahead: 131072       â”‚     â”‚
         â”‚  â”‚ flags: ASYNC_READ |         â”‚     â”‚
         â”‚  â”‚        WRITEBACK_CACHE |    â”‚     â”‚
         â”‚  â”‚        PARALLEL_DIROPS | ...â”‚     â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
         â”‚                                      â”‚
         â”‚  FUSE_INIT reply                     â”‚
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
         â”‚  â”‚ major: 7                    â”‚     â”‚
         â”‚  â”‚ minor: 38                   â”‚     â”‚
         â”‚  â”‚ max_write: 1048576          â”‚     â”‚
         â”‚  â”‚ flags: ASYNC_READ |         â”‚     â”‚
         â”‚  â”‚        BIG_WRITES | ...     â”‚     â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
         â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         â”‚                                      â”‚
```

**å…³é”®åå•†å‚æ•°ï¼š**

| å‚æ•° | è¯´æ˜ |
|------|------|
| `major`/`minor` | åè®®ç‰ˆæœ¬ï¼ŒåŒæ–¹å–æœ€å°å€¼ |
| `max_readahead` | å†…æ ¸é¢„è¯»çª—å£å¤§å° |
| `max_write` | å•æ¬¡å†™è¯·æ±‚æœ€å¤§å­—èŠ‚æ•° |
| `flags` | èƒ½åŠ›æ ‡å¿—ä½ï¼ˆè§ä¸‹è¡¨ï¼‰ |

**å¸¸ç”¨èƒ½åŠ›æ ‡å¿—ï¼š**

| Flag | ä½œç”¨ | Scorpio ä½¿ç”¨ |
|------|------|--------------|
| `FUSE_ASYNC_READ` | å…è®¸å¹¶å‘è¯»è¯·æ±‚ | âœ… |
| `FUSE_WRITEBACK_CACHE` | å¯ç”¨å†…æ ¸å†™å›ç¼“å­˜ | âœ… |
| `FUSE_PARALLEL_DIROPS` | å…è®¸å¹¶å‘ç›®å½•æ“ä½œ | âœ… |
| `FUSE_BIG_WRITES` | æ”¯æŒå¤§äº 4KB çš„å†™è¯·æ±‚ | âœ… |
| `FUSE_READDIRPLUS` | `readdir` åŒæ—¶è¿”å›å±æ€§ | âœ… |
| `FUSE_PASSTHROUGH` | ç›´æ¥ I/O ç©¿é€ï¼ˆLinux 6.9+ï¼‰ | ğŸ”œ |

#### ç‰ˆæœ¬å…¼å®¹

FUSE åè®®ç‰ˆæœ¬æ¼”è¿›ï¼ˆèŠ‚é€‰ï¼‰ï¼š

| ç‰ˆæœ¬ | å¼•å…¥ç‰¹æ€§ |
|------|----------|
| 7.23 | `FUSE_WRITEBACK_CACHE` |
| 7.28 | `FUSE_PARALLEL_DIROPS` |
| 7.31 | `FUSE_EXPLICIT_INVAL_DATA` |
| 7.38 | `FUSE_PASSTHROUGH`ï¼ˆå®éªŒæ€§ï¼‰ |

Scorpio åŸºäº `rfuse3`ï¼Œç›®å‰æ”¯æŒåˆ° 7.31+ï¼Œå¯¹ä½ç‰ˆæœ¬å†…æ ¸ä¼šè‡ªåŠ¨é™çº§ç¦ç”¨æ–°ç‰¹æ€§ã€‚

### 3.2 FUSE çš„æ€§èƒ½å±€é™

å°½ç®¡ FUSE æä¾›äº†æå¤§çš„çµæ´»æ€§ï¼Œä½†å…¶æ¶æ„å†³å®šäº†å‡ ä¸ªå›ºæœ‰ç“¶é¢ˆï¼š

#### ç”¨æˆ·æ€-å†…æ ¸æ€åˆ‡æ¢å¼€é”€

```text
ä¼ ç»Ÿæ–‡ä»¶ç³»ç»Ÿ (ext4):
  App â†’ syscall â†’ VFS â†’ ext4 â†’ è¿”å›
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              1 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢

FUSE æ–‡ä»¶ç³»ç»Ÿ:
  App â†’ syscall â†’ VFS â†’ FUSE kernel â†’ /dev/fuse
                                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
  FUSE daemon (ç”¨æˆ·æ€å¤„ç†) â†’ /dev/fuse â†’ FUSE kernel â†’ è¿”å›
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        4 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢
```

è¿™æ„å‘³ç€ï¼š
- æ¯æ¬¡æ–‡ä»¶æ“ä½œè‡³å°‘ **4 æ¬¡ç”¨æˆ·/å†…æ ¸æ€åˆ‡æ¢**
- æ•°æ®éœ€è¦åœ¨å†…æ ¸ç¼“å†²åŒºå’Œç”¨æˆ·æ€ä¹‹é—´ **å¤šæ¬¡æ‹·è´**
- å¯¹äºå°æ–‡ä»¶å¯†é›†å‹ I/Oï¼ˆå¦‚ `npm install`ï¼‰ï¼Œå¼€é”€æ˜¾è‘—

#### å®æµ‹å¯¹æ¯”

| æ“ä½œ | ext4 | FUSE (å…¸å‹) | å¼€é”€å€æ•° |
|------|------|-------------|----------|
| é¡ºåºè¯» 4KB | 3 Î¼s | 15 Î¼s | ~5x |
| éšæœºè¯» 4KB | 8 Î¼s | 35 Î¼s | ~4x |
| `stat()` | 0.5 Î¼s | 5 Î¼s | ~10x |
| `readdir` 100 é¡¹ | 20 Î¼s | 150 Î¼s | ~7x |

> æ•°æ®æ¥æºï¼šåŸºäº Linux 5.15 çš„å…¸å‹ benchmarkï¼Œå®é™…ç»“æœå› åœºæ™¯è€Œå¼‚ã€‚

### 3.3 æ€§èƒ½ä¼˜åŒ–ä¸ Bypass æ–¹æ¡ˆ

ä¸ºäº†è§£å†³ FUSE çš„æ€§èƒ½ç“¶é¢ˆï¼Œä¸šç•Œæœ‰å‡ ç§æ¢ç´¢æ–¹å‘ï¼š

#### 3.3.1 FUSE Passthroughï¼ˆLinux 6.9+ï¼‰

ä» Linux 6.9 å¼€å§‹ï¼ŒFUSE å¼•å…¥äº† **passthrough** æ¨¡å¼ï¼šå¯¹äºå·²çŸ¥çš„æœ¬åœ°æ–‡ä»¶ï¼Œå¯ä»¥ç»•è¿‡ç”¨æˆ·æ€å®ˆæŠ¤è¿›ç¨‹ï¼Œç›´æ¥ç”±å†…æ ¸å®Œæˆ I/Oã€‚

```text
æ™®é€š FUSE è¯»å–:
  read() â†’ kernel â†’ /dev/fuse â†’ daemon â†’ è¯»å–åç«¯ â†’ è¿”å›

Passthrough æ¨¡å¼:
  read() â†’ kernel â†’ ç›´æ¥è¯»å–åç«¯æ–‡ä»¶ â†’ è¿”å›
                    (ç»•è¿‡ daemon)
```

é€‚ç”¨åœºæ™¯ï¼š
- Overlay çš„ upper/lower å±‚æ˜¯æœ¬åœ°æ–‡ä»¶
- åªè¯»æ–‡ä»¶çš„ç¼“å­˜å‘½ä¸­å

Scorpio çš„ `libfuse-fs` æ­£åœ¨è¯„ä¼° passthrough æ”¯æŒï¼Œå¯æ˜¾è‘—é™ä½å·²ç¼“å­˜æ–‡ä»¶çš„è®¿é—®å»¶è¿Ÿã€‚

#### 3.3.2 io_uring ä¸ FUSE

io_uring æä¾›äº†é«˜æ€§èƒ½çš„å¼‚æ­¥ I/O æ¥å£ï¼Œä¸ FUSE ç»“åˆå¯ä»¥ï¼š

- å‡å°‘ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°ï¼ˆæ‰¹é‡æäº¤ï¼‰
- é™ä½ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€
- æ”¯æŒé›¶æ‹·è´ï¼ˆç‰¹å®šåœºæ™¯ï¼‰

```rust
// rfuse3 æœªæ¥å¯èƒ½çš„ io_uring é›†æˆæ–¹å‘
// (å½“å‰ä»ä½¿ç”¨ epoll/kqueue)
let ring = IoUring::new(256)?;
ring.submitter().register_files(&[fuse_fd])?;
```

ç›®å‰ `rfuse3` ä»åŸºäº tokio çš„ epoll æ¨¡å‹ï¼Œio_uring æ”¯æŒåœ¨è·¯çº¿å›¾ä¸­ã€‚

#### 3.3.3 virtiofsï¼šè™šæ‹ŸåŒ–åœºæ™¯çš„æœ€ä¼˜è§£

å¯¹äºè™šæ‹Ÿæœº/å®¹å™¨åœºæ™¯ï¼Œvirtiofs æä¾›äº†æ¯”ä¼ ç»Ÿ FUSE æ›´å¥½çš„æ€§èƒ½ï¼š

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Guest VM      â”‚     â”‚      Host       â”‚
â”‚                 â”‚     â”‚                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ virtiofs  â”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â–ºâ”‚ virtiofsd â”‚  â”‚
â”‚  â”‚  (kernel) â”‚  â”‚     â”‚  â”‚           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                 â”‚     â”‚        â”‚        â”‚
â”‚  å…±äº«å†…å­˜ç›´é€š   â”‚     â”‚        â–¼        â”‚
â”‚  (DAX window)   â”‚â—„â”€â”€â”€â”€â”¼â”€â”€â”€â”€ Host FS     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ä¼˜åŠ¿ï¼š
- ä½¿ç”¨ virtio åè®®ï¼Œå‡å°‘è™šæ‹ŸåŒ–å¼€é”€
- æ”¯æŒ DAXï¼ˆç›´æ¥è®¿é—®ï¼‰æ¨¡å¼ï¼Œé›¶æ‹·è´
- Guest å†…æ–‡ä»¶æ“ä½œå»¶è¿Ÿæ¥è¿‘ Host åŸç”Ÿ

| æ–¹æ¡ˆ | é€‚ç”¨åœºæ™¯ | å»¶è¿Ÿ | åå |
|------|----------|------|------|
| ä¼ ç»Ÿ FUSE | é€šç”¨ | é«˜ | ä¸­ |
| FUSE + Passthrough | æœ¬åœ°åç«¯ | ä½ | é«˜ |
| virtiofs | VM/å®¹å™¨ | ä½ | å¾ˆé«˜ |
| virtiofs + DAX | VM | æä½ | æé«˜ |

### 3.4 FUSE åº“å¯¹æ¯”

ä¸åŒè¯­è¨€å’Œåœºæ™¯æœ‰å¤šç§ FUSE åº“å¯é€‰ï¼š

| åº“ | è¯­è¨€ | å¼‚æ­¥ | ç‰¹ç‚¹ | ç”Ÿæ€ |
|----|------|------|------|------|
| **libfuse** | C | âŒ | å®˜æ–¹å‚è€ƒå®ç°ï¼ŒåŠŸèƒ½å®Œæ•´ | â­â­â­â­â­ |
| **go-fuse** | Go | âœ… (goroutine) | é«˜çº§å°è£…ï¼Œæ˜“ç”¨ | â­â­â­â­ |
| **fuser** | Rust | âŒ | åŒæ­¥ APIï¼Œç®€å•ç¨³å®š | â­â­â­ |
| **rfuse3** | Rust | âœ… (tokio) | å¼‚æ­¥ï¼Œåº•å±‚æ§åˆ¶å¼º | â­â­â­ |
| **polyfuse** | Rust | âœ… | å®éªŒæ€§ï¼ŒAPI å‹å¥½ | â­â­ |

#### ä¸ºä»€ä¹ˆ Scorpio é€‰æ‹© rfuse3ï¼Ÿ

1. **å¼‚æ­¥åŸç”Ÿ**ï¼šScorpio å¤§é‡ç½‘ç»œ I/Oï¼Œéœ€è¦ä¸ tokio ç”Ÿæ€æ— ç¼é›†æˆ
2. **åº•å±‚æ§åˆ¶**ï¼šå¯ä»¥ç²¾ç¡®æ§åˆ¶ FUSE_INIT åå•†çš„èƒ½åŠ›æ ‡å¿—
3. **æ€§èƒ½å¯¼å‘**ï¼šæ”¯æŒ `READDIRPLUS`ã€`PARALLEL_DIROPS` ç­‰ä¼˜åŒ–ç‰¹æ€§
4. **Rust å®‰å…¨æ€§**ï¼šå†…å­˜å®‰å…¨ï¼Œé€‚åˆé•¿æœŸè¿è¡Œçš„å®ˆæŠ¤è¿›ç¨‹

```rust
// rfuse3 çš„ MountOptions é…ç½®ç¤ºä¾‹
let mut options = MountOptions::default();
options
    .force_readdir_plus(true)      // å¯ç”¨ READDIRPLUS
    .uid(getuid())
    .gid(getgid());
```

#### libfuse vs rfuse3 API å¯¹æ¯”

```c
// libfuse (C) - åŒæ­¥å›è°ƒ
static int my_read(const char *path, char *buf, size_t size,
                   off_t offset, struct fuse_file_info *fi) {
    // åŒæ­¥è¯»å–ï¼Œé˜»å¡å½“å‰çº¿ç¨‹
    return pread(fi->fh, buf, size, offset);
}
```

```rust
// rfuse3 (Rust) - å¼‚æ­¥å›è°ƒ
async fn read(
    &self,
    _req: Request,
    inode: u64,
    fh: u64,
    offset: u64,
    size: u32,
) -> Result<ReplyData> {
    // å¼‚æ­¥è¯»å–ï¼Œä¸é˜»å¡ executor
    let data = self.backend.read(inode, offset, size).await?;
    Ok(ReplyData { data })
}
```

---

## å››ã€Scorpio æ•´ä½“æ¶æ„

### 4.1 è®¾è®¡ç›®æ ‡


Scorpio çš„æ•´ä½“è®¾è®¡å¯ä»¥æ¦‚æ‹¬ä¸ºå››ä¸ªæ ¸å¿ƒç›®æ ‡ï¼š

1. **æŒ‰éœ€åŠ è½½**ï¼šè®¿é—®æŸä¸ªæ–‡ä»¶æ—¶æ‰ä»æœåŠ¡å™¨æ‹‰å–å†…å®¹ï¼ŒèŠ‚çœå¸¦å®½å’Œæœ¬åœ°ç£ç›˜
2. **æœ¬åœ°è¯»å†™**ï¼šåœ¨æŒ‚è½½ç›®å½•ä¸‹è¡¨ç°å¾—åƒä¸€ä¸ªæ™®é€šä»“åº“ï¼Œæ”¯æŒå¸¸è§„è¯»å†™æ“ä½œ
3. **ç‰ˆæœ¬æ§åˆ¶**ï¼šä¸ Git æµç¨‹é›†æˆï¼Œæ”¯æŒ `commit`ã€`push` ç­‰æ“ä½œ
4. **æ„å»ºéš”ç¦»**ï¼šä¸º CI/CD æä¾›ç‹¬ç«‹çš„æ„å»ºå·¥ä½œç©ºé—´

### 4.2 åˆ†å±‚æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              åº”ç”¨å±‚                                    â”‚
â”‚                                                                         â”‚
â”‚   å¼€å‘è€…å·¥å…· (IDE, ç¼–è¯‘å™¨, è„šæœ¬)                                         â”‚
â”‚         â”‚                                                               â”‚
â”‚         â–¼                                                               â”‚
â”‚   /workspace/src/main.rs  (æŒ‚è½½ç‚¹)                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            FUSE æ¥å£å±‚                                 â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                         MegaFuse                               â”‚   â”‚
â”‚   â”‚                                                                â”‚   â”‚
â”‚   â”‚   èŒè´£:                                                        â”‚   â”‚
â”‚   â”‚   - å®ç° FUSE Filesystem trait                                 â”‚   â”‚
â”‚   â”‚   - ç®¡ç†å¤šä¸ª OverlayFs å®ä¾‹                                     â”‚   â”‚
â”‚   â”‚   - Inode åˆ†é…å’Œæ˜ å°„                                            â”‚   â”‚
â”‚   â”‚   - å°†è¯·æ±‚è·¯ç”±åˆ°å¯¹åº”çš„æ–‡ä»¶ç³»ç»Ÿå±‚                                 â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           è”åˆæ–‡ä»¶ç³»ç»Ÿå±‚                                â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                        OverlayFs                               â”‚   â”‚
â”‚   â”‚                                                                â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚   â”‚   â”‚  Upper Layer (è¯»å†™å±‚)                                  â”‚     â”‚   â”‚
â”‚   â”‚   â”‚  - Passthrough åˆ°æœ¬åœ°ç›®å½•                              â”‚     â”‚   â”‚
â”‚   â”‚   â”‚  - æ‰€æœ‰å†™æ“ä½œéƒ½åœ¨è¿™é‡Œ                                   â”‚     â”‚   â”‚
â”‚   â”‚   â”‚  - Copy-on-Write è¯­ä¹‰                                  â”‚     â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚   â”‚
â”‚   â”‚   â”‚  CL Layer (å¯é€‰ï¼Œå˜æ›´åˆ—è¡¨å±‚)                            â”‚     â”‚   â”‚
â”‚   â”‚   â”‚  - ç”¨äº CI/CD åœºæ™¯çš„å¢é‡å˜æ›´                            â”‚     â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚   â”‚
â”‚   â”‚   â”‚  Lower Layer (åªè¯»å±‚)                                  â”‚     â”‚   â”‚
â”‚   â”‚   â”‚  - Dicfuse è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ                                 â”‚     â”‚   â”‚
â”‚   â”‚   â”‚  - ä» Mega æœåŠ¡å™¨æŒ‰éœ€æ‹‰å–                               â”‚     â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            æ•°æ®å­˜å‚¨å±‚                                  â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚   Tree Store     â”‚  â”‚  Content Store   â”‚  â”‚   Local Store    â”‚     â”‚
â”‚   â”‚                  â”‚  â”‚                  â”‚  â”‚                  â”‚     â”‚
â”‚   â”‚  ç›®å½•æ ‘å…ƒæ•°æ®     â”‚  â”‚  æ–‡ä»¶å†…å®¹ç¼“å­˜    â”‚  â”‚  æœ¬åœ°ä¿®æ”¹æ•°æ®     â”‚     â”‚
â”‚   â”‚  (sled DB)       â”‚  â”‚  (å†…å­˜+ç£ç›˜)     â”‚  â”‚  (passthrough)   â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            ç½‘ç»œå±‚                                      â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                      Mega Server API                           â”‚   â”‚
â”‚   â”‚                                                                â”‚   â”‚
â”‚   â”‚  GET /api/v1/tree/{commit_id}     è·å–ç›®å½•æ ‘                    â”‚   â”‚
â”‚   â”‚  GET /api/v1/blob/{blob_id}       è·å–æ–‡ä»¶å†…å®¹                  â”‚   â”‚
â”‚   â”‚  POST /api/v1/commit              æäº¤å˜æ›´                      â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 æ¨¡å—èŒè´£æ¦‚è§ˆ

| æ¨¡å— | ä½ç½® | èŒè´£ |
|------|------|------|
| **MegaFuse** | `fuse/mod.rs` | FUSE å…¥å£ï¼Œç®¡ç†å¤šä¸ª overlay å®ä¾‹ |
| **Dicfuse** | `dicfuse/mod.rs` | åªè¯»è™šæ‹Ÿå±‚ï¼Œæä¾›ç›®å½•æ ‘å’ŒæŒ‰éœ€åŠ è½½ |
| **OverlayFs** | `libfuse-fs` | è”åˆæ–‡ä»¶ç³»ç»Ÿï¼Œåˆå¹¶å¤šå±‚è§†å›¾ |
| **Antares** | `antares/` | è½»é‡çº§æŒ‚è½½ï¼Œç”¨äº CI/CD éš”ç¦» |
| **Manager** | `manager/` | Git æ“ä½œï¼šcommit, push, diff |
| **Daemon** | `daemon/` | HTTP API æœåŠ¡ |

---

## äº”ã€æ ¸å¿ƒç»„ä»¶æ‹†è§£

### 5.1 Dicfuseï¼šæŒ‰éœ€åŠ è½½çš„åªè¯»å±‚

Dicfuse æ˜¯ Scorpio é‡Œçš„ã€Œè™šæ‹Ÿåªè¯»å±‚ã€ï¼Œå®ç°äº†ä¸€ä¸ª"å­—å…¸å¼"æ–‡ä»¶ç³»ç»Ÿï¼šç›®å½•æ ‘ç»“æ„å’Œæ–‡ä»¶å†…å®¹åˆ†å¼€å­˜å‚¨ï¼Œå†…å®¹æŒ‰éœ€åŠ è½½ã€‚

```rust
pub struct Dicfuse {
    readable: bool,
    pub store: Arc<DictionaryStore>,  // å…ƒæ•°æ®å­˜å‚¨
}

impl Dicfuse {
    /// æŒ‰éœ€åŠ è½½æ–‡ä»¶å†…å®¹
    async fn load_one_file(&self, parent: u64, name: &OsStr) -> std::io::Result<()> {
        // 1. æŸ¥æ‰¾çˆ¶ç›®å½•çš„ Tree å¯¹è±¡
        let parent_item = self.store.find_path(parent).await?;
        let tree = fetch_tree(&parent_item).await?;

        // 2. åœ¨ Tree ä¸­æ‰¾åˆ°ç›®æ ‡æ–‡ä»¶
        for item in tree.tree_items {
            if item.name == name && item.mode == Blob {
                // 3. ä»æœåŠ¡å™¨æ‹‰å– Blob å†…å®¹
                let url = format!("{}/{}", blob_endpoint, item.id);
                let content = client.get(url).send().await?.bytes().await?;

                // 4. ç¼“å­˜åˆ°æœ¬åœ°
                self.store.save_file(inode, content.to_vec());
            }
        }
        Ok(())
    }
}
```

**è¯»å–æ—¶çš„å…³é”®è·¯å¾„ï¼š**

```text
                     é¦–æ¬¡è®¿é—® /workspace/src/main.rs
                                    â”‚
                                    â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Dicfuse.lookup("src", "main.rs")       â”‚
              â”‚                                         â”‚
              â”‚  1. æ£€æŸ¥æœ¬åœ°ç¼“å­˜ â†’ æœªå‘½ä¸­               â”‚
              â”‚  2. æŸ¥è¯¢ Tree Store è·å–å…ƒæ•°æ®          â”‚
              â”‚     â†’ æ‰¾åˆ°: inode=42, size=1024        â”‚
              â”‚  3. è¿”å›æ–‡ä»¶å±æ€§ï¼ˆä¸åŠ è½½å†…å®¹ï¼‰          â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Dicfuse.read(inode=42, offset=0)       â”‚
              â”‚                                         â”‚
              â”‚  1. æ£€æŸ¥ Content Store â†’ æœªå‘½ä¸­         â”‚
              â”‚  2. ä» Mega æœåŠ¡å™¨æ‹‰å– Blob             â”‚
              â”‚     GET /api/v1/blob/{sha1}            â”‚
              â”‚  3. å­˜å…¥ Content Store                  â”‚
              â”‚  4. è¿”å›æ–‡ä»¶å†…å®¹                        â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ç›®å½•ç»“æ„å¯ä»¥æå‰çŸ¥é“ï¼ŒçœŸæ­£çš„å†…å®¹åªæœ‰åœ¨éœ€è¦æ—¶æ‰ä»æœåŠ¡å™¨æ‹‰ä¸‹æ¥ã€‚

### 5.2 OverlayFsï¼šè”åˆæ–‡ä»¶ç³»ç»Ÿ

OverlayFs æŠŠå¤šå±‚æ–‡ä»¶ç³»ç»Ÿç»„åˆæˆä¸€ä¸ªç»Ÿä¸€è§†å›¾ï¼Œæ˜¯ã€Œåªè¯»è¿œç¨‹å±‚ + æœ¬åœ°è¯»å†™å±‚ã€è¿™ä¸ªè®¾è®¡çš„æ ¸å¿ƒã€‚

```text
                    ç”¨æˆ·è§†è§’ï¼ˆåˆå¹¶è§†å›¾ï¼‰
                    /workspace/
                    â”œâ”€â”€ src/
                    â”‚   â”œâ”€â”€ main.rs      (æ¥è‡ª Upperï¼Œå·²ä¿®æ”¹)
                    â”‚   â””â”€â”€ lib.rs       (æ¥è‡ª Lowerï¼Œåªè¯»)
                    â””â”€â”€ Cargo.toml       (æ¥è‡ª Lowerï¼Œåªè¯»)

         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â–¼                 â–¼                 â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Upper Layer â”‚  â”‚  CL Layer   â”‚  â”‚ Lower Layer â”‚
     â”‚  (è¯»å†™)     â”‚  â”‚  (å¯é€‰)     â”‚  â”‚  (åªè¯»)     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚ src/        â”‚  â”‚             â”‚  â”‚ src/        â”‚
     â”‚   main.rs âœ â”‚  â”‚             â”‚  â”‚   main.rs   â”‚
     â”‚             â”‚  â”‚             â”‚  â”‚   lib.rs    â”‚
     â”‚             â”‚  â”‚             â”‚  â”‚ Cargo.toml  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **è¯»æ“ä½œä¼˜å…ˆçº§**ï¼š`Upper > CL > Lower`
- **å†™æ“ä½œ**ï¼šå§‹ç»ˆå†™å…¥ Upper å±‚ï¼ˆCopy-on-Writeï¼‰

```rust
impl MegaFuse {
    /// æŒ‚è½½ä¸€ä¸ª overlay æ–‡ä»¶ç³»ç»Ÿ
    pub async fn overlay_mount(
        &self,
        inode: u64,
        store_path: &Path,
        need_cl: bool,
        cl_link: Option<&str>,
    ) -> std::io::Result<()> {
        // æ„å»ºå±‚ç»“æ„
        let lower = store_path.join("lower");   // Dicfuse æ˜ å°„
        let upper = store_path.join("upper");   // æœ¬åœ°å†™å…¥å±‚

        let mut lower_layers = vec![];

        // å¯é€‰çš„ CL å±‚
        if need_cl {
            let cl_path = store_path.join("cl").join(cl_link);
            lower_layers.push(new_passthroughfs_layer(cl_path));
        }

        // æ·»åŠ åªè¯»ä¸‹å±‚
        lower_layers.push(new_passthroughfs_layer(lower));

        // åˆ›å»ºè¯»å†™ä¸Šå±‚
        let upper_layer = new_passthroughfs_layer(upper);

        // ç»„è£… OverlayFs
        let overlayfs = OverlayFs::new(
            Some(upper_layer),  // è¯»å†™å±‚
            lower_layers,       // åªè¯»å±‚åˆ—è¡¨
            config,
            inode,
        )?;

        self.overlayfs.lock().await.insert(inode, Arc::new(overlayfs));
        Ok(())
    }
}
```

### 5.3 Inode ç®¡ç†

FUSE é€šè¿‡ inode å”¯ä¸€æ ‡è¯†æ–‡ä»¶ã€‚Scorpio éœ€è¦åœ¨å¤šä¸ª overlay å®ä¾‹ä¹‹é—´é¿å… inode å†²çªï¼Œå› æ­¤ä¼šåšã€ŒæŒ‰æ‰¹åˆ†é…ã€ï¼š

```rust
pub struct InodeAlloc {
    // æ¯ä¸ª overlay åˆ†é…ä¸€ä¸ª inode åŒºé—´
    // é¿å…ä¸åŒ overlay çš„ inode å†²çª
    allocations: Mutex<HashMap<u64, InodeBatch>>,
}

struct InodeBatch {
    start: u64,
    end: u64,
    next: u64,
}

impl InodeAlloc {
    /// ä¸ºæ–°çš„ overlay åˆ†é… inode æ‰¹æ¬¡
    pub async fn alloc_inode(&self, overlay_inode: u64) -> InodeBatch {
        let mut alloc = self.allocations.lock().await;

        // è®¡ç®—æ–°çš„åŒºé—´
        let batch_size = 0x1000_0000;  // æ¯ä¸ª overlay åˆ†é… 256M ä¸ª inode
        let start = overlay_inode * batch_size;
        let end = start + batch_size - 1;

        let batch = InodeBatch { start, end, next: start + 1 };
        alloc.insert(overlay_inode, batch);
        batch
    }
}
```

### 5.4 Antaresï¼šCI/CD æ„å»ºéš”ç¦»

Antares æ˜¯åŸºäº Scorpio æŠ½å‡ºæ¥çš„ä¸€ä¸ªã€Œé¢å‘ CI/CD çš„æŒ‚è½½å±‚ã€ï¼Œå…³æ³¨ç‚¹æ˜¯ï¼š

- ä¸ºæ¯ä¸ªæ„å»º Job æä¾›ç‹¬ç«‹çš„ Upper å±‚
- å…±äº«åªè¯»çš„ Dicfuse å±‚ï¼ŒèŠ‚çœå†…å­˜å’Œç½‘ç»œ

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       CI/CD Pipeline                        â”‚
â”‚                                                              â”‚
â”‚  Job 1 â”€â”€â”€â”€â”€â–º Antares Mount â”€â”€â”€â”€â”€â–º /mnt/job1/                â”‚
â”‚               (ç‹¬ç«‹å·¥ä½œç©ºé—´)        â”œâ”€â”€ src/ (Dicfuse)        â”‚
â”‚                                    â””â”€â”€ build/ (Upper)        â”‚
â”‚                                                              â”‚
â”‚  Job 2 â”€â”€â”€â”€â”€â–º Antares Mount â”€â”€â”€â”€â”€â–º /mnt/job2/                â”‚
â”‚               (ç‹¬ç«‹å·¥ä½œç©ºé—´)        â”œâ”€â”€ src/ (Dicfuse)        â”‚
â”‚                                    â””â”€â”€ build/ (Upper)        â”‚
â”‚                                                              â”‚
â”‚  å…±äº«åªè¯»å±‚ï¼šDicfuseï¼ˆå•ä¾‹ï¼ŒèŠ‚çœå†…å­˜ï¼‰                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å®ç°ä¸Šåªæ˜¯å¯¹ overlay çš„ä¸€ä¸ªåŒ…è£…ï¼š

```rust
pub struct AntaresFuse {
    pub mountpoint: PathBuf,
    pub upper_dir: PathBuf,           // ç‹¬ç«‹çš„å†™å…¥å±‚
    pub dic: Arc<Dicfuse>,            // å…±äº«çš„åªè¯»å±‚
    pub cl_dir: Option<PathBuf>,      // å¯é€‰çš„ CL å±‚
    fuse_task: Option<JoinHandle<()>>,
}

impl AntaresFuse {
    /// æ„å»º overlay å¹¶æŒ‚è½½
    pub async fn mount(&mut self) -> std::io::Result<()> {
        let overlay = self.build_overlay().await?;

        // å¯åŠ¨ FUSE ä¼šè¯
        let handle = mount_filesystem(overlay, &self.mountpoint).await;

        self.fuse_task = Some(tokio::spawn(async move {
            let _ = handle.await;
        }));

        Ok(())
    }

    /// å¸è½½
    pub async fn unmount(&mut self) -> std::io::Result<()> {
        // è°ƒç”¨ fusermount -u å¸è½½
        Command::new("fusermount")
            .arg("-u")
            .arg(&self.mountpoint)
            .output()
            .await?;
        Ok(())
    }
}
```

---

## å…­ã€å…³é”®è·¯å¾„æ‹†è§£

### 6.1 å¯åŠ¨æµç¨‹

```rust
#[tokio::main]
async fn main() {
    // 1. åŠ è½½é…ç½®
    config::init_config("scorpio.toml")?;

    // 2. åˆå§‹åŒ– ScorpioManagerï¼Œæ£€æŸ¥å·¥ä½œç›®å½•çŠ¶æ€
    let mut manager = ScorpioManager::from_toml(config_file)?;
    manager.check().await;  // åŒæ­¥ç›®å½•æ ‘å…ƒæ•°æ®

    // 3. åˆ›å»º MegaFuseï¼ŒæŒ‚è½½å·¥ä½œç›®å½•
    let fuse = MegaFuse::new_from_manager(&manager).await;

    // 4. å¯åŠ¨ FUSE ä¼šè¯
    let mount_handle = mount_filesystem(fuse, mountpoint).await;

    // 5. å¯åŠ¨ HTTP daemon
    tokio::spawn(daemon_main(Arc::new(fuse), manager));

    // 6. ç­‰å¾…é€€å‡ºä¿¡å·
    tokio::select! {
        _ = mount_handle => {},
        _ = signal::ctrl_c() => {
            mount_handle.unmount().await?;
        }
    }
}
```

### 6.2 æ–‡ä»¶è¯»å–æµç¨‹

```text
ç”¨æˆ·æ‰§è¡Œ: cat /workspace/src/main.rs
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. VFS â†’ FUSE å†…æ ¸æ¨¡å— â†’ /dev/fuse                     â”‚
â”‚     FUSE_LOOKUP: parent=1, name="src"                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. MegaFuse.lookup(parent=1, name="src")               â”‚
â”‚     â†’ æŸ¥æ‰¾ overlay æ˜ å°„                                  â”‚
â”‚     â†’ å§”æ‰˜ç»™ OverlayFs.lookup()                          â”‚
â”‚     â†’ è¿”å› inode=2, attr={dir, mode=0755}               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. MegaFuse.lookup(parent=2, name="main.rs")           â”‚
â”‚     â†’ OverlayFs æŒ‰ä¼˜å…ˆçº§æŸ¥æ‰¾ï¼š                           â”‚
â”‚       a. Upper å±‚ï¼šä¸å­˜åœ¨                                â”‚
â”‚       b. Lower å±‚ (Dicfuse)ï¼šå­˜åœ¨å…ƒæ•°æ®                  â”‚
â”‚     â†’ è¿”å› inode=42, attr={file, size=1024}             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. MegaFuse.open(inode=42, flags=O_RDONLY)             â”‚
â”‚     â†’ è¿”å› file handle                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. MegaFuse.read(inode=42, offset=0, size=4096)        â”‚
â”‚     â†’ OverlayFs.read() â†’ Dicfuse.read()                 â”‚
â”‚     â†’ æ£€æŸ¥ Content Storeï¼šæœªå‘½ä¸­                         â”‚
â”‚     â†’ HTTP GET /api/v1/blob/{sha1}                      â”‚
â”‚     â†’ ç¼“å­˜å†…å®¹åˆ° Content Store                           â”‚
â”‚     â†’ è¿”å›æ–‡ä»¶æ•°æ®                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 æ–‡ä»¶å†™å…¥ï¼ˆCopy-on-Writeï¼‰

```text
ç”¨æˆ·æ‰§è¡Œ: echo "new content" >> /workspace/src/main.rs
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. MegaFuse.open(inode=42, flags=O_WRONLY|O_APPEND)    â”‚
â”‚     â†’ OverlayFs æ£€æµ‹åˆ°å†™æ“ä½œ                             â”‚
â”‚     â†’ è§¦å‘ Copy-on-Write                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Copy-on-Write è¿‡ç¨‹ï¼š                                â”‚
â”‚     a. ä» Lower å±‚è¯»å–åŸå§‹å†…å®¹                           â”‚
â”‚     b. åœ¨ Upper å±‚åˆ›å»ºåŒåæ–‡ä»¶                           â”‚
â”‚     c. å°†åŸå§‹å†…å®¹å¤åˆ¶åˆ° Upper å±‚                         â”‚
â”‚     d. æ ‡è®° Upper å±‚æ–‡ä»¶ä¸º"è¦†ç›–"                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. MegaFuse.write(inode=42, data="new content\n")      â”‚
â”‚     â†’ å†™å…¥ Upper å±‚æ–‡ä»¶                                  â”‚
â”‚     â†’ Lower å±‚åŸå§‹æ–‡ä»¶ä¿æŒä¸å˜                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å†™å…¥åçš„å±‚ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Upper Layer â”‚  src/main.rs  â† åŒ…å«æ–°å†…å®¹
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Lower Layer â”‚  src/main.rs  â† åŸå§‹å†…å®¹ï¼ˆè¢«é®ç›–ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.4 æäº¤æµç¨‹

```text
ç”¨æˆ·æ‰§è¡Œ: scorpio commit -m "update main.rs"
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. æ‰«æ Upper å±‚å˜æ›´                                    â”‚
â”‚     â†’ éå† upper/ ç›®å½•                                   â”‚
â”‚     â†’ æ”¶é›†æ‰€æœ‰ä¿®æ”¹/æ–°å¢/åˆ é™¤çš„æ–‡ä»¶                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. æ„å»º Git å¯¹è±¡                                        â”‚
â”‚     a. ä¸ºæ¯ä¸ªä¿®æ”¹çš„æ–‡ä»¶åˆ›å»º Blob å¯¹è±¡                    â”‚
â”‚     b. æ„å»ºæ–°çš„ Tree å¯¹è±¡ï¼ˆåˆå¹¶å˜æ›´ï¼‰                    â”‚
â”‚     c. åˆ›å»º Commit å¯¹è±¡                                  â”‚
â”‚        - parent: ä¸Šä¸€ä¸ª commit                          â”‚
â”‚        - tree: æ–°çš„æ ¹ tree                              â”‚
â”‚        - message: "update main.rs"                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. æ¨é€åˆ°æœåŠ¡å™¨                                         â”‚
â”‚     POST /api/v1/commit                                 â”‚
â”‚     Body: { objects: [...], commit: {...} }             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. æ›´æ–°æœ¬åœ°çŠ¶æ€                                         â”‚
â”‚     â†’ æ¸…ç©º Upper å±‚                                      â”‚
â”‚     â†’ æ›´æ–° Tree Store åˆ°æ–° commit                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸ƒã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 7.1 å…ƒæ•°æ®é¢„å–

ç›®å½•æ ‘å¯ä»¥æå‰æ‹‰å–ï¼Œé™ä½é¦–æ¬¡è®¿é—®å»¶è¿Ÿï¼š

```rust
impl Dicfuse {
    /// æ‰¹é‡é¢„å–ç›®å½•å†…å®¹
    pub async fn prefetch_directory(&self, inode: u64) {
        let tree = fetch_tree(inode).await;

        // å°†æ‰€æœ‰å­é¡¹å…ƒæ•°æ®å­˜å…¥ Tree Store
        for item in tree.items {
            self.store.insert_metadata(item);
        }
    }
}
```

### 7.2 å†…å®¹ç¼“å­˜ç­–ç•¥

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç¼“å­˜å±‚æ¬¡                              â”‚
â”‚                                                         â”‚
â”‚  L1: å†…å­˜ç¼“å­˜ (LRUï¼Œé™åˆ¶å¤§å°)                           â”‚
â”‚       â†“ miss                                            â”‚
â”‚  L2: æœ¬åœ°ç£ç›˜ç¼“å­˜ (Content Store)                       â”‚
â”‚       â†“ miss                                            â”‚
â”‚  L3: Mega æœåŠ¡å™¨                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 å¹¶å‘æ§åˆ¶

å¯¹è¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œç”¨ `RwLock` åšç®€å•çš„è¯»å†™åˆ†ç¦»ï¼š

```rust
pub struct DictionaryStore {
    tree_cache: RwLock<HashMap<u64, TreeNode>>,
    content_cache: RwLock<HashMap<u64, Vec<u8>>>,
}

// è¯»æ“ä½œä½¿ç”¨è¯»é”ï¼Œå…è®¸å¹¶å‘
async fn get_metadata(&self, inode: u64) -> Option<TreeNode> {
    self.tree_cache.read().await.get(&inode).cloned()
}

// å†™æ“ä½œä½¿ç”¨å†™é”
async fn insert_metadata(&self, inode: u64, node: TreeNode) {
    self.tree_cache.write().await.insert(inode, node);
}
```

---

## å…«ã€ä¸å…¶ä»–æ–¹æ¡ˆå¯¹æ¯”

| ç‰¹æ€§ | Scorpio | Git Sparse Checkout | VFS for Git | GitFS |
|------|---------|---------------------|-------------|-------|
| æŒ‰éœ€åŠ è½½ | âœ… | âŒï¼ˆéœ€é¢„å®šä¹‰ï¼‰ | âœ… | âœ… |
| æœ¬åœ°ä¿®æ”¹ | âœ… | âœ… | âœ… | âŒ |
| ç‰ˆæœ¬æ§åˆ¶ | âœ…ï¼ˆå†…ç½®ï¼‰ | âœ…ï¼ˆGitï¼‰ | âœ…ï¼ˆGitï¼‰ | âŒ |
| æ„å»ºéš”ç¦» | âœ…ï¼ˆAntaresï¼‰ | âŒ | âŒ | âŒ |
| å®ç°æ–¹å¼ | FUSE | Git åŸç”Ÿ | FUSE | FUSE |
| å¹³å°æ”¯æŒ | Linux/macOS | å…¨å¹³å° | Windows | Linux |

---

## ä¹ã€ä½¿ç”¨ç¤ºä¾‹

### 9.1 åŸºæœ¬ä½¿ç”¨

```bash
# å¯åŠ¨ Scorpio
./scorpio -c scorpio.toml

# æŸ¥çœ‹æŒ‚è½½çš„å·¥ä½œç©ºé—´
ls /workspace
# src/  Cargo.toml  README.md

# åƒæ™®é€šä»“åº“ä¸€æ ·ä½¿ç”¨
cd /workspace
cargo build
vim src/main.rs

# æäº¤å˜æ›´
curl -X POST http://localhost:8000/api/commit \
  -H "Content-Type: application/json" \
  -d '{"message": "fix bug"}'
```

### 9.2 Antares åœ¨ CI/CD ä¸­çš„ä½¿ç”¨

```bash
# å¯åŠ¨ Antares daemon
./antares serve --bind 0.0.0.0:2726

# åˆ›å»ºæ„å»ºç¯å¢ƒ
curl -X POST http://localhost:2726/mounts \
  -H "Content-Type: application/json" \
  -d '{
    "mountpoint": "/mnt/job1",
    "upper_dir": "/var/antares/upper/job1",
    "labels": ["ci", "build"],
    "readonly": false
  }'

# åœ¨éš”ç¦»ç¯å¢ƒä¸­æ„å»º
cd /mnt/job1
./build.sh

# æ¸…ç†
curl -X DELETE http://localhost:2726/mounts/{mount_id}
```

---

## åã€æ€»ç»“

ä»æ•´ä½“ä¸Šçœ‹ï¼ŒScorpio ç”¨ FUSE æ­äº†ä¸€å¥—é€‚åˆå¤§ä½“é‡ monorepo çš„è®¿é—®æ–¹æ¡ˆï¼š

1. **FUSE æä¾›åŸºç¡€è®¾æ–½**ï¼šæŠŠæ–‡ä»¶ç³»ç»Ÿé€»è¾‘æ”¾åœ¨ç”¨æˆ·æ€ï¼Œé¿å…å†…æ ¸å¼€å‘æˆæœ¬
2. **Dicfuse è´Ÿè´£æŒ‰éœ€åŠ è½½**ï¼šç›®å½•æ ‘å’Œæ–‡ä»¶å†…å®¹è§£è€¦ï¼Œå†…å®¹æŒ‰è®¿é—®æ‡’åŠ è½½
3. **OverlayFs æä¾›æœ¬åœ°è¯»å†™è¯­ä¹‰**ï¼šCopy-on-Write ä¿æŠ¤è¿œç¨‹åªè¯»å±‚ï¼ŒåŒæ—¶å…è®¸æœ¬åœ°ä¿®æ”¹
4. **Antares é¢å‘ CI/CD åšéš”ç¦»**ï¼šä¸ºæµæ°´çº¿æ„å»ºæä¾›è½»é‡ã€å¯å›æ”¶çš„å·¥ä½œç©ºé—´

è¿™ç§ç»„åˆåœ¨ä»¥ä¸‹åœºæ™¯ç‰¹åˆ«æœ‰ä»·å€¼ï¼š

- è¶…å¤§ä½“é‡ monorepoï¼ˆæ•°å GB ç”šè‡³æ›´å¤§ï¼‰
- é¢‘ç¹åˆ‡æ¢åˆ†æ”¯ / é¡¹ç›®å­ç›®å½•
- CI/CD æ„å»ºéš”ç¦»å’Œç¼“å­˜å¤ç”¨
- å¸¦å®½æˆ–ç£ç›˜èµ„æºå—é™çš„ç¯å¢ƒ

---

## å‚è€ƒèµ„æ–™

- [FUSE Protocol Specification](https://libfuse.github.io/doxygen/)
- [Linux OverlayFS Documentation](https://docs.kernel.org/filesystems/overlayfs.html)
- [rfuse3 - Rust FUSE Library](https://docs.rs/rfuse3)
- [Mega Project](https://github.com/web3infra-foundation/mega)
