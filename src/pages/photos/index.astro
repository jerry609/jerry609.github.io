---
import { getCollection } from 'astro:content'
import PageLayout from '@/layouts/CommonPage.astro'

const title = 'Photos'

// Fetch photos from Content Collections
const photos = (await getCollection('photos')).sort((a, b) => {
  // Sort by ID (filename) numerically
  return parseInt(a.data.id) - parseInt(b.data.id)
})
---

<PageLayout {title}>
  <div class='mx-auto max-w-screen-xl px-4 py-8'>
    <!-- Photo Grid (Masonry) -->
    <div class='columns-1 gap-4 sm:columns-2 lg:columns-3 space-y-4'>
      {
        photos.map((photo, index) => (
          <article
            class='photo-card group break-inside-avoid mb-4'
            style={`animation-delay: ${index * 50}ms`}
            data-story={photo.data.story}
            data-mood={photo.data.mood}
            data-photo-id={photo.data.id}
          >
            <div class='relative overflow-hidden rounded-lg bg-muted shadow-photo transition-all duration-300 hover:-translate-y-1 hover:shadow-photo-hover'>
              <img
                src={photo.data.src}
                alt={photo.data.alt || photo.data.title}
                title={photo.data.title}
                loading='lazy'
                class='zoomable w-full h-auto object-cover transition-transform duration-500 group-hover:scale-105'
              />
              <div class='absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/60 to-transparent p-4 opacity-0 transition-opacity duration-300 group-hover:opacity-100'>
                <h2 class='text-sm font-medium text-white'>{photo.data.title}</h2>
                {photo.data.mood && (
                  <span class='text-xs text-white/80'>{photo.data.mood}</span>
                )}
              </div>

              {/* Story overlay (hidden by default) */}
              {photo.data.story && (
                <div class='story-overlay'>
                  <div class='story-content'>
                    <p class='story-text'>{photo.data.story}</p>
                  </div>
                </div>
              )}
            </div>

            {/* Interaction Bar */}
            <div class='interaction-bar'>
              {/* Like Button */}
              <button
                class='like-btn'
                data-photo-id={photo.data.id}
                aria-label='Like this photo'
              >
                <span class='heart-icon'>â¤ï¸</span>
                <span class='like-count'>0</span>
              </button>

              {/* Comment Button */}
              <button
                class='comment-btn'
                data-photo-id={photo.data.id}
                aria-label='View comments'
              >
                <span class='comment-icon'>ğŸ’¬</span>
                <span class='comment-count'>0</span>
              </button>
            </div>

            {/* Comments Section (hidden by default) */}
            <div class='comments-section' data-photo-id={photo.data.id}>
              <div class='comments-list'></div>
              <form class='comment-form'>
                <input
                  type='text'
                  class='comment-username'
                  placeholder='ä½ çš„æ˜µç§°'
                  maxlength='50'
                  required
                />
                <textarea
                  class='comment-input'
                  placeholder='ç•™ä¸‹ä½ çš„æƒ³æ³•...'
                  maxlength='500'
                  rows='2'
                  required
                ></textarea>
                <button type='submit' class='comment-submit'>å‘é€</button>
              </form>
            </div>
          </article>
        ))
      }
    </div>

    <!-- Empty State -->
    {
      photos.length === 0 && (
        <div class='text-center py-16'>
          <p class='text-muted-foreground text-lg'>æš‚æ— ç…§ç‰‡ï¼Œæ•¬è¯·æœŸå¾…...</p>
        </div>
      )
    }
  </div>

  <!-- Particle container for Konoha effects -->
  <div id='particle-container' aria-hidden='true'></div>
</PageLayout>

<style>
  /* Entry Animation */
  article {
    animation: fade-up 0.6s ease-out backwards;
  }

  @keyframes fade-up {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Dark mode optimized shadows */
  .shadow-photo {
    box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
  }

  .shadow-photo-hover {
    box-shadow: 0 10px 25px -5px rgb(0 0 0 / 0.15), 0 8px 10px -6px rgb(0 0 0 / 0.1);
  }

  /* Dark mode adjustments */
  @media (prefers-color-scheme: dark) {
    .shadow-photo {
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.3), 0 1px 2px -1px rgb(0 0 0 / 0.2);
    }

    .shadow-photo-hover {
      box-shadow: 0 10px 25px -5px rgb(0 0 0 / 0.4), 0 8px 10px -6px rgb(0 0 0 / 0.3);
    }
  }

  /* Story overlay */
  .story-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 10;
  }

  .story-overlay.active {
    opacity: 1;
    pointer-events: auto;
  }

  .story-content {
    padding: 1.5rem;
    max-width: 90%;
    animation: story-slide-up 0.3s ease-out;
  }

  .story-text {
    color: white;
    font-size: 0.875rem;
    line-height: 1.6;
    text-align: center;
  }

  @keyframes story-slide-up {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Particle container */
  #particle-container {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 9999;
  }

  /* Particle styles */
  .particle {
    position: absolute;
    pointer-events: none;
    font-size: 1.5rem;
    animation: float-away 2s ease-out forwards;
  }

  @keyframes float-away {
    0% {
      opacity: 1;
      transform: translateY(0) rotate(0deg);
    }
    100% {
      opacity: 0;
      transform: translateY(-100px) rotate(180deg);
    }
  }

  /* Ensure medium-zoom works */
  .zoomable {
    cursor: zoom-in;
  }

  .photo-card {
    position: relative;
  }

  /* Interaction Bar */
  .interaction-bar {
    display: flex;
    gap: 1rem;
    padding: 0.75rem 1rem;
    background: hsl(var(--card));
    border-top: 1px solid hsl(var(--border));
  }

  .like-btn,
  .comment-btn {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    border: 1px solid hsl(var(--border));
    border-radius: 0.375rem;
    background: transparent;
    color: hsl(var(--foreground));
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .like-btn:hover,
  .comment-btn:hover {
    background: hsl(var(--muted));
    transform: translateY(-1px);
  }

  .like-btn.liked {
    background: hsl(var(--primary) / 0.1);
    border-color: hsl(var(--primary));
    color: hsl(var(--primary));
  }

  .like-btn.liked .heart-icon {
    animation: heart-beat 0.3s ease;
  }

  @keyframes heart-beat {
    0%,
    100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.3);
    }
  }

  /* Comments Section */
  .comments-section {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
    background: hsl(var(--muted) / 0.3);
  }

  .comments-section.open {
    max-height: 500px;
    overflow-y: auto;
  }

  .comments-list {
    padding: 1rem;
    max-height: 300px;
    overflow-y: auto;
  }

  .comment-item {
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    background: hsl(var(--card));
    border-radius: 0.375rem;
    border-left: 2px solid hsl(var(--primary));
  }

  .comment-author {
    font-weight: 600;
    font-size: 0.875rem;
    color: hsl(var(--primary));
    margin-bottom: 0.25rem;
  }

  .comment-text {
    font-size: 0.875rem;
    color: hsl(var(--foreground));
    line-height: 1.5;
  }

  .comment-time {
    font-size: 0.75rem;
    color: hsl(var(--muted-foreground));
    margin-top: 0.25rem;
  }

  .comment-form {
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    border-top: 1px solid hsl(var(--border));
  }

  .comment-username,
  .comment-input {
    padding: 0.5rem 0.75rem;
    border: 1px solid hsl(var(--border));
    border-radius: 0.375rem;
    background: hsl(var(--card));
    color: hsl(var(--foreground));
    font-size: 0.875rem;
  }

  .comment-username {
    width: 50%;
  }

  .comment-input {
    resize: vertical;
    font-family: inherit;
  }

  .comment-submit {
    align-self: flex-end;
    padding: 0.5rem 1.5rem;
    background: hsl(var(--primary));
    color: hsl(var(--primary-foreground));
    border: none;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .comment-submit:hover {
    opacity: 0.9;
    transform: translateY(-1px);
  }

  .comment-submit:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .empty-comments {
    padding: 2rem 1rem;
    text-align: center;
    color: hsl(var(--muted-foreground));
    font-size: 0.875rem;
  }
</style>

<script>
  // Long-press detection
  let pressTimer: number | null = null
  let currentCard: HTMLElement | null = null

  document.addEventListener('DOMContentLoaded', () => {
    const photoCards = document.querySelectorAll('.photo-card')

    photoCards.forEach((card) => {
      const element = card as HTMLElement
      const story = element.dataset.story
      if (!story) return

      const overlay = element.querySelector('.story-overlay') as HTMLElement

      // Mouse/Touch start
      const startPress = (e: Event) => {
        e.preventDefault()
        pressTimer = window.setTimeout(() => {
          overlay?.classList.add('active')
          currentCard = element
          // Haptic feedback simulation
          element.style.transform = 'scale(0.98)'
        }, 500)
      }

      // Mouse/Touch end
      const endPress = () => {
        if (pressTimer) {
          clearTimeout(pressTimer)
          pressTimer = null
        }
        overlay?.classList.remove('active')
        element.style.transform = ''
        currentCard = null
      }

      element.addEventListener('mousedown', startPress)
      element.addEventListener('touchstart', startPress)
      element.addEventListener('mouseup', endPress)
      element.addEventListener('mouseleave', endPress)
      element.addEventListener('touchend', endPress)
      element.addEventListener('touchcancel', endPress)
    })

    // Konoha effect: Click anywhere to spawn particles
    document.addEventListener('click', (e) => {
      // Don't trigger on zoom clicks
      if ((e.target as HTMLElement).classList.contains('zoomable')) return

      createParticles(e.clientX, e.clientY)
    })
  })

  // Particle effects
  function createParticles(x: number, y: number) {
    const container = document.getElementById('particle-container')
    if (!container) return

    const emojis = ['ğŸƒ', 'ğŸŒ¸', 'ğŸ‚', 'âœ¨', 'ğŸŒº']
    const count = Math.floor(Math.random() * 3) + 2

    for (let i = 0; i < count; i++) {
      const particle = document.createElement('div')
      particle.className = 'particle'
      particle.textContent = emojis[Math.floor(Math.random() * emojis.length)]
      particle.style.left = `${x}px`
      particle.style.top = `${y}px`
      particle.style.setProperty('--rotation', `${Math.random() * 360}deg`)

      container.appendChild(particle)

      // Remove after animation
      setTimeout(() => {
        particle.remove()
      }, 2000)
    }
  }
</script>

<script>
  import {
    likePhoto,
    unlikePhoto,
    getPhotoLikes,
    hasUserLiked,
    addComment,
    getComments,
    getCommentCount
  } from '@/utils/supabase'

  document.addEventListener('DOMContentLoaded', async () => {
    // Initialize all photo cards with Supabase data
    const photoCards = document.querySelectorAll('.photo-card')

    for (const card of photoCards) {
      const photoId = (card as HTMLElement).dataset.photoId
      if (!photoId) continue

      // Load likes
      const { count: likeCount } = await getPhotoLikes(photoId)
      const { liked } = await hasUserLiked(photoId)

      const likeBtn = card.querySelector('.like-btn') as HTMLButtonElement
      const likeCountSpan = likeBtn?.querySelector('.like-count') as HTMLSpanElement

      if (likeCountSpan) likeCountSpan.textContent = String(likeCount)
      if (liked && likeBtn) likeBtn.classList.add('liked')

      // Load comments count
      const { count: commentCount } = await getCommentCount(photoId)
      const commentCountSpan = card.querySelector('.comment-count') as HTMLSpanElement
      if (commentCountSpan) commentCountSpan.textContent = String(commentCount)
    }

    // Like button handlers
    document.querySelectorAll('.like-btn').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation()
        const button = e.currentTarget as HTMLButtonElement
        const photoId = button.dataset.photoId
        if (!photoId) return

        const isLiked = button.classList.contains('liked')
        const likeCountSpan = button.querySelector('.like-count') as HTMLSpanElement

        if (isLiked) {
          // Unlike
          await unlikePhoto(photoId)
          button.classList.remove('liked')
          likeCountSpan.textContent = String(Number(likeCountSpan.textContent) - 1)
        } else {
          // Like
          const result = await likePhoto(photoId)
          if (result.alreadyLiked) return // Already liked

          button.classList.add('liked')
          likeCountSpan.textContent = String(Number(likeCountSpan.textContent) + 1)
        }
      })
    })

    // Comment button handlers (toggle comments section)
    document.querySelectorAll('.comment-btn').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation()
        const button = e.currentTarget as HTMLButtonElement
        const photoId = button.dataset.photoId
        if (!photoId) return

        const commentsSection = document.querySelector(
          `.comments-section[data-photo-id="${photoId}"]`
        ) as HTMLElement

        if (!commentsSection) return

        const isOpen = commentsSection.classList.contains('open')

        if (isOpen) {
          commentsSection.classList.remove('open')
        } else {
          commentsSection.classList.add('open')
          // Load comments
          await loadComments(photoId)
        }
      })
    })

    // Comment form handlers
    document.querySelectorAll('.comment-form').forEach((form) => {
      form.addEventListener('submit', async (e) => {
        e.preventDefault()
        const formElement = e.currentTarget as HTMLFormElement
        const photoId = formElement.closest('.comments-section')?.getAttribute('data-photo-id')
        if (!photoId) return

        const usernameInput = formElement.querySelector('.comment-username') as HTMLInputElement
        const commentInput = formElement.querySelector('.comment-input') as HTMLTextAreaElement
        const submitBtn = formElement.querySelector('.comment-submit') as HTMLButtonElement

        const username = usernameInput.value.trim()
        const comment = commentInput.value.trim()

        if (!username || !comment) return

        // Disable form
        submitBtn.disabled = true
        submitBtn.textContent = 'å‘é€ä¸­...'

        // Add comment
        const { error } = await addComment(photoId, username, comment)

        if (error) {
          alert('è¯„è®ºå‘é€å¤±è´¥ï¼Œè¯·ç¨åå†è¯•')
          submitBtn.disabled = false
          submitBtn.textContent = 'å‘é€'
          return
        }

        // Clear form
        usernameInput.value = ''
        commentInput.value = ''
        submitBtn.disabled = false
        submitBtn.textContent = 'å‘é€'

        // Reload comments
        await loadComments(photoId)

        // Update comment count
        const { count } = await getCommentCount(photoId)
        const commentCountSpan = document.querySelector(
          `.comment-btn[data-photo-id="${photoId}"] .comment-count`
        ) as HTMLSpanElement
        if (commentCountSpan) commentCountSpan.textContent = String(count)
      })
    })
  })

  async function loadComments(photoId: string) {
    const { data: comments } = await getComments(photoId)
    const commentsList = document.querySelector(
      `.comments-section[data-photo-id="${photoId}"] .comments-list`
    ) as HTMLElement

    if (!commentsList) return

    if (comments.length === 0) {
      commentsList.innerHTML = '<div class="empty-comments">è¿˜æ²¡æœ‰è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§ï¼</div>'
      return
    }

    commentsList.innerHTML = comments
      .map(
        (comment: {
          id: number
          username: string
          comment: string
          created_at: string
        }) => {
          const date = new Date(comment.created_at)
          const timeAgo = getTimeAgo(date)

          return `
          <div class="comment-item">
            <div class="comment-author">${escapeHtml(comment.username)}</div>
            <div class="comment-text">${escapeHtml(comment.comment)}</div>
            <div class="comment-time">${timeAgo}</div>
          </div>
        `
        }
      )
      .join('')
  }

  function getTimeAgo(date: Date): string {
    const seconds = Math.floor((new Date().getTime() - date.getTime()) / 1000)

    if (seconds < 60) return 'åˆšåˆš'
    if (seconds < 3600) return `${Math.floor(seconds / 60)} åˆ†é’Ÿå‰`
    if (seconds < 86400) return `${Math.floor(seconds / 3600)} å°æ—¶å‰`
    if (seconds < 2592000) return `${Math.floor(seconds / 86400)} å¤©å‰`
    return date.toLocaleDateString('zh-CN')
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div')
    div.textContent = text
    return div.innerHTML
  }
</script>
