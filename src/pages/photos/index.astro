---
import { getCollection } from 'astro:content'
import PageLayout from '@/layouts/CommonPage.astro'

const title = 'Photos'

// Fetch photos from Content Collections
const photos = (await getCollection('photos')).sort((a, b) => {
  return parseInt(a.data.id) - parseInt(b.data.id)
})

const photoIds = photos.map(p => p.data.id)
---

<PageLayout {title}>
  <div class='mx-auto max-w-screen-xl px-4 py-8'>
    <!-- Stats Header -->
    <div class='grid grid-cols-1 sm:grid-cols-3 gap-4 mb-12'>
      <div class='flex items-center gap-4 p-5 bg-card/80 backdrop-blur-sm border border-border rounded-2xl shadow-sm hover:shadow-md hover:border-primary/30 transition-all duration-300 hover:-translate-y-0.5 group'>
        <span class='text-3xl group-hover:scale-110 transition-transform'>üì∏</span>
        <div class='flex flex-col'>
          <span class='text-2xl font-bold leading-none text-foreground'>{photos.length}</span>
          <span class='text-xs font-medium uppercase tracking-wider text-muted-foreground mt-1'>Photos</span>
        </div>
      </div>
      <div class='flex items-center gap-4 p-5 bg-card/80 backdrop-blur-sm border border-border rounded-2xl shadow-sm hover:shadow-md hover:border-primary/30 transition-all duration-300 hover:-translate-y-0.5 group'>
        <span class='text-3xl group-hover:scale-110 transition-transform'>üí¨</span>
        <div class='flex flex-col'>
          <span class='text-2xl font-bold leading-none text-foreground' id='total-comments'>-</span>
          <span class='text-xs font-medium uppercase tracking-wider text-muted-foreground mt-1'>Comments</span>
        </div>
      </div>
      {/* Placeholder for future stat or just decoration */}
      <div class='hidden sm:flex items-center gap-4 p-5 bg-card/50 border border-border/50 rounded-2xl border-dashed'>
        <span class='text-3xl opacity-50'>‚ú®</span>
        <div class='flex flex-col'>
          <span class='text-sm text-muted-foreground'>More moments captured soon...</span>
        </div>
      </div>
    </div>

    <!-- Photo Grid (Masonry) -->
    <div class='columns-1 gap-6 sm:columns-2 lg:columns-3 space-y-6'>
      {
        photos.map((photo, index) => (
          <article
            class='photo-card relative mb-6 break-inside-avoid rounded-2xl border border-border bg-card overflow-hidden shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-500 group'
            style={`animation: fade-up 0.6s ease-out backwards ${index * 100}ms`}
            data-story={photo.data.story}
            data-mood={photo.data.mood}
            data-photo-id={photo.data.id}
          >
            <!-- Image Container -->
            <div class='relative overflow-hidden bg-muted aspect-[4/3]'>
              <img
                src={photo.data.src}
                alt={photo.data.alt || photo.data.title}
                title={photo.data.title}
                loading='lazy'
                class='photo-image block w-full h-full object-cover cursor-zoom-in transition-transform duration-700 group-hover:scale-110'
                data-zoomable
              />
              
              <!-- Hover Overlay -->
              <div class='hover-overlay absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-6'>
                <h2 class='text-white font-bold text-lg drop-shadow-md transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300'>{photo.data.title}</h2>
                {photo.data.mood && (
                  <span class='text-white/80 text-sm mt-1 drop-shadow-sm transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300 delay-75'>{photo.data.mood}</span>
                )}
              </div>

              <!-- Story Overlay (Long Press) -->
              {photo.data.story && (
                <div class='story-overlay absolute inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 z-10'>
                  <div class='p-8 text-center transform translate-y-4 transition-transform duration-300'>
                    <div class='text-4xl mb-4'>üìñ</div>
                    <p class='text-white/90 text-sm leading-relaxed max-w-[280px]'>{photo.data.story}</p>
                  </div>
                </div>
              )}
            </div>

            <!-- Interaction Bar -->
            <div class='interaction-bar flex items-center justify-between p-3 border-t border-border/50 bg-card/95 backdrop-blur-sm'>
              <button
                class='action-btn comment-btn flex items-center gap-2 px-3 py-1.5 rounded-full bg-muted/50 hover:bg-muted text-xs font-medium transition-colors'
                data-photo-id={photo.data.id}
                aria-label='ËØÑËÆ∫'
              >
                <span>üí¨</span>
                <span class='comment-count min-w-[1rem] text-center'>-</span>
              </button>

              <button
                class='action-btn share-btn p-2 rounded-full hover:bg-muted text-muted-foreground hover:text-foreground transition-colors'
                data-photo-id={photo.data.id}
                aria-label='ÂàÜ‰∫´'
              >
                <span class='text-sm'>üì§</span>
              </button>
            </div>

            <!-- Comments Section -->
            <div class='comments-section max-h-0 overflow-hidden transition-[max-height] duration-300 ease-in-out bg-muted/30' data-photo-id={photo.data.id}>
              <div class='comments-list p-4 max-h-[280px] overflow-y-auto space-y-3' />
              
              <form class='comment-form p-4 border-t border-border/50 flex flex-col gap-3'>
                <input
                  type='text'
                  class='comment-username w-full px-3 py-2 rounded-lg bg-background border border-border text-sm focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all'
                  placeholder='Name'
                  maxlength='30'
                  required
                />
                <textarea
                  class='comment-input w-full px-3 py-2 rounded-lg bg-background border border-border text-sm focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all resize-none'
                  placeholder='Add a comment...'
                  maxlength='500'
                  rows='2'
                  required
                />
                <button type='submit' class='comment-submit self-end px-4 py-1.5 rounded-full bg-primary text-primary-foreground text-xs font-bold hover:shadow-lg hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed transition-all'>
                  <span class='submit-text'>Send</span>
                  <span class='submit-loading hidden'>Sending...</span>
                </button>
              </form>
            </div>
          </article>
        ))
      }
    </div>

    <!-- Empty State -->
    {
      photos.length === 0 && (
        <div class='text-center py-20'>
          <span class='text-6xl block mb-4 opacity-20 grayscale'>üì∑</span>
          <p class='text-muted-foreground text-lg'>No photos yet...</p>
        </div>
      )
    }
  </div>

  <!-- Particle Effects Container -->
  <div id='particle-container' aria-hidden='true' class="fixed inset-0 pointer-events-none z-[9999]" />

  <!-- Pass photoIds to client -->
  <script define:vars={{ photoIds }}>
    window.__photoIds = photoIds
  </script>
</PageLayout>

<style>
  /* Essential Custom Animations & States that Tailwind utilities might not cover easily or cleanly */
  
  @keyframes fade-up {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .story-overlay.active {
    opacity: 1;
    pointer-events: auto;
  }
  
  .story-overlay.active div {
    transform: translateY(0);
  }

  .comments-section.open {
    max-height: 600px;
  }

  /* Particle Animation */
  :global(.particle) {
    position: absolute;
    pointer-events: none;
    font-size: 1.5rem;
    animation: float-away 2s ease-out forwards;
  }

  @keyframes float-away {
    0% { opacity: 1; transform: translateY(0) rotate(0deg) scale(1); }
    100% { opacity: 0; transform: translateY(-80px) rotate(180deg) scale(0.5); }
  }
  
  /* Loading state for button */
  .comment-submit.loading .submit-text { display: none; }
  .comment-submit.loading .submit-loading { display: inline; }
</style>

<script>
  import mediumZoom from 'medium-zoom'
  import {
    getAllPhotosStats,
    addComment,
    getComments,
    getCommentCount,
  } from '@/utils/supabase'

  document.addEventListener('DOMContentLoaded', async () => {
    const photoIds = (window as any).__photoIds as string[]

    // ===== Initialize Medium Zoom =====
    const zoom = mediumZoom('[data-zoomable]', {
      margin: 24,
      background: 'hsl(0 0% 0% / 0.9)',
      scrollOffset: 0,
    })

    // ===== Long Press for Story =====
    let pressTimer: number | null = null

    document.querySelectorAll('.photo-card').forEach((card) => {
      const element = card as HTMLElement
      const story = element.dataset.story
      if (!story) return

      const overlay = element.querySelector('.story-overlay') as HTMLElement

      const startPress = (e: Event) => {
        if ((e.target as HTMLElement).hasAttribute('data-zoomable')) return
        
        // Prevent default only if checking for long press on non-interactive elements
        // But we want to allow scrolling. 
        // e.preventDefault() -> removed to allow scroll on mobile start
        
        pressTimer = window.setTimeout(() => {
          overlay?.classList.add('active')
          element.style.transform = 'scale(0.98)'
          // Vibrate if available
          if (navigator.vibrate) navigator.vibrate(50);
        }, 500)
      }

      const endPress = () => {
        if (pressTimer) {
          clearTimeout(pressTimer)
          pressTimer = null
        }
        overlay?.classList.remove('active')
        element.style.transform = ''
      }

      element.addEventListener('mousedown', startPress)
      element.addEventListener('touchstart', startPress, { passive: true })
      element.addEventListener('mouseup', endPress)
      element.addEventListener('mouseleave', endPress)
      element.addEventListener('touchend', endPress)
      element.addEventListener('touchcancel', endPress)
    })

    // ===== Particle Effects =====
    const createParticles = (x: number, y: number) => {
      const container = document.getElementById('particle-container')
      if (!container) return

      const emojis = ['üçÉ', 'üå∏', 'üçÇ', '‚ú®', 'üå∫', 'üí´']
      const count = Math.floor(Math.random() * 3) + 2

      for (let i = 0; i < count; i++) {
        const particle = document.createElement('div')
        particle.className = 'particle'
        particle.textContent = emojis[Math.floor(Math.random() * emojis.length)]
        particle.style.left = `${x + (Math.random() - 0.5) * 30}px`
        particle.style.top = `${y}px`
        container.appendChild(particle)
        setTimeout(() => particle.remove(), 2000)
      }
    }

    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement
      if (target.hasAttribute('data-zoomable') || target.closest('.action-btn, .comment-form, .medium-zoom-overlay')) return
      createParticles(e.clientX, e.clientY)
    })

    // ===== Load Stats (Batch Query) =====
    // Note: If Supabase utils are missing in this environment, this might fail silently or error.
    // Assuming utils/supabase exists as per previous code.
    try {
        const statsMap = await getAllPhotosStats(photoIds)
        
        let totalComments = 0

        statsMap.forEach((stats, photoId) => {
          totalComments += stats.commentCount

          const card = document.querySelector(`[data-photo-id="${photoId}"]`) as HTMLElement
          if (!card) return

          const commentCount = card.querySelector('.comment-count')
          if (commentCount) commentCount.textContent = String(stats.commentCount)
        })

        const totalCommentsEl = document.getElementById('total-comments')
        if (totalCommentsEl) totalCommentsEl.textContent = String(totalComments)
    } catch (e) {
        console.warn('Failed to load stats', e)
    }

    // ===== Username localStorage =====
    const STORAGE_KEY = 'photo_comment_username'
    const savedUsername = localStorage.getItem(STORAGE_KEY) || ''

    document.querySelectorAll('.comment-username').forEach((input) => {
      const el = input as HTMLInputElement
      el.value = savedUsername
    })

    // ===== Comment Toggle =====
    document.querySelectorAll('.comment-btn').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation()
        const photoId = (e.currentTarget as HTMLButtonElement).dataset.photoId
        if (!photoId) return

        const section = document.querySelector(
          `.comments-section[data-photo-id="${photoId}"]`
        ) as HTMLElement

        if (section.classList.contains('open')) {
          section.classList.remove('open')
        } else {
          section.classList.add('open')
          // Add basic logic to load comments here if implementation exists
        }
      })
    })

    // ===== Share Button =====
    document.querySelectorAll('.share-btn').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation()
        const photoId = (e.currentTarget as HTMLElement).dataset.photoId
        const url = `${window.location.origin}/photos#photo-${photoId}`

        if (navigator.share) {
          try {
            await navigator.share({ title: 'Photo Share', url })
          } catch (err) {
             // share cancelled
          }
        } else {
            // Fallback: Copy to clipboard
            try {
                await navigator.clipboard.writeText(url);
                alert('Link copied to clipboard!');
            } catch(err) {
                console.error('Failed to copy', err);
            }
        }
      })
    })
  })
</script>
