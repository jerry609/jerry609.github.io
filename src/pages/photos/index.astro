---
import { getCollection } from 'astro:content'
import PageLayout from '@/layouts/CommonPage.astro'

const title = 'Photos'

// Fetch photos from Content Collections
const photos = (await getCollection('photos')).sort((a, b) => {
  return parseInt(a.data.id) - parseInt(b.data.id)
})

const photoIds = photos.map(p => p.data.id)
---

<PageLayout {title}>
  <div class='mx-auto max-w-screen-xl px-4 py-8'>
    <!-- Stats Header -->
    <div class='stats-header'>
      <div class='stat-card'>
        <span class='stat-icon'>üì∏</span>
        <div class='stat-info'>
          <span class='stat-value'>{photos.length}</span>
          <span class='stat-label'>ÁÖßÁâá</span>
        </div>
      </div>
      <div class='stat-card'>
        <span class='stat-icon'>‚ù§Ô∏è</span>
        <div class='stat-info'>
          <span class='stat-value' id='total-likes'>-</span>
          <span class='stat-label'>ÁÇπËµû</span>
        </div>
      </div>
      <div class='stat-card'>
        <span class='stat-icon'>üí¨</span>
        <div class='stat-info'>
          <span class='stat-value' id='total-comments'>-</span>
          <span class='stat-label'>ËØÑËÆ∫</span>
        </div>
      </div>
    </div>

    <!-- Photo Grid (Masonry) -->
    <div class='columns-1 gap-5 sm:columns-2 lg:columns-3 space-y-5'>
      {
        photos.map((photo, index) => (
          <article
            class='photo-card group break-inside-avoid'
            style={`animation-delay: ${index * 60}ms`}
            data-story={photo.data.story}
            data-mood={photo.data.mood}
            data-photo-id={photo.data.id}
          >
            <!-- Image Container -->
            <div class='image-wrapper'>
              <img
                src={photo.data.src}
                alt={photo.data.alt || photo.data.title}
                title={photo.data.title}
                loading='lazy'
                class='photo-image'
                data-zoomable
              />
              
              <!-- Hover Overlay -->
              <div class='hover-overlay'>
                <h2 class='photo-title'>{photo.data.title}</h2>
                {photo.data.mood && (
                  <span class='photo-mood'>{photo.data.mood}</span>
                )}
              </div>

              <!-- Story Overlay (Long Press) -->
              {photo.data.story && (
                <div class='story-overlay'>
                  <div class='story-content'>
                    <div class='story-icon'>üìñ</div>
                    <p class='story-text'>{photo.data.story}</p>
                  </div>
                </div>
              )}

              <!-- Loading Skeleton -->
              <div class='image-skeleton'>
                <div class='skeleton-shimmer' />
              </div>
            </div>

            <!-- Interaction Bar -->
            <div class='interaction-bar'>
              <button
                class='action-btn like-btn'
                data-photo-id={photo.data.id}
                aria-label='ÁÇπËµû'
              >
                <span class='btn-icon'>‚ù§Ô∏è</span>
                <span class='btn-count like-count'>
                  <span class='count-skeleton' />
                </span>
              </button>

              <button
                class='action-btn comment-btn'
                data-photo-id={photo.data.id}
                aria-label='ËØÑËÆ∫'
              >
                <span class='btn-icon'>üí¨</span>
                <span class='btn-count comment-count'>
                  <span class='count-skeleton' />
                </span>
              </button>

              <button
                class='action-btn share-btn'
                data-photo-id={photo.data.id}
                aria-label='ÂàÜ‰∫´'
              >
                <span class='btn-icon'>üì§</span>
              </button>
            </div>

            <!-- Comments Section -->
            <div class='comments-section' data-photo-id={photo.data.id}>
              <div class='comments-list' />
              <form class='comment-form'>
                <div class='form-row'>
                  <input
                    type='text'
                    class='comment-username'
                    placeholder='ÊòµÁß∞'
                    maxlength='30'
                    required
                  />
                </div>
                <div class='form-row'>
                  <textarea
                    class='comment-input'
                    placeholder='Áïô‰∏ã‰Ω†ÁöÑÊÉ≥Ê≥ï...'
                    maxlength='500'
                    rows='2'
                    required
                  />
                </div>
                <button type='submit' class='comment-submit'>
                  <span class='submit-text'>ÂèëÈÄÅ</span>
                  <span class='submit-loading'>ÂèëÈÄÅ‰∏≠...</span>
                </button>
              </form>
            </div>
          </article>
        ))
      }
    </div>

    <!-- Empty State -->
    {
      photos.length === 0 && (
        <div class='empty-state'>
          <span class='empty-icon'>üì∑</span>
          <p class='empty-text'>ÊöÇÊó†ÁÖßÁâáÔºåÊï¨ËØ∑ÊúüÂæÖ...</p>
        </div>
      )
    }
  </div>

  <!-- Particle Effects Container -->
  <div id='particle-container' aria-hidden='true' />

  <!-- Pass photoIds to client -->
  <script define:vars={{ photoIds }}>
    window.__photoIds = photoIds
  </script>
</PageLayout>

<style>
  /* ===== Stats Header ===== */
  .stats-header {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.25rem;
    background: linear-gradient(135deg, hsl(var(--card)) 0%, hsl(var(--muted) / 0.3) 100%);
    border: 1px solid hsl(var(--border));
    border-radius: 1rem;
    transition: all 0.3s ease;
  }

  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px hsl(var(--primary) / 0.1);
    border-color: hsl(var(--primary) / 0.3);
  }

  .stat-icon {
    font-size: 1.75rem;
  }

  .stat-info {
    display: flex;
    flex-direction: column;
  }

  .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: hsl(var(--foreground));
    line-height: 1.2;
  }

  .stat-label {
    font-size: 0.75rem;
    color: hsl(var(--muted-foreground));
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* ===== Photo Card ===== */
  .photo-card {
    position: relative;
    background: hsl(var(--card));
    border-radius: 1rem;
    overflow: hidden;
    box-shadow: 0 4px 20px hsl(var(--foreground) / 0.05);
    border: 1px solid hsl(var(--border));
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    animation: card-enter 0.6s ease-out backwards;
  }

  .photo-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px hsl(var(--foreground) / 0.12);
    border-color: hsl(var(--primary) / 0.2);
  }

  @keyframes card-enter {
    from {
      opacity: 0;
      transform: translateY(24px) scale(0.96);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  /* ===== Image ===== */
  .image-wrapper {
    position: relative;
    overflow: hidden;
    background: hsl(var(--muted));
  }

  .photo-image {
    width: 100%;
    height: auto;
    display: block;
    cursor: zoom-in;
    transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .photo-card:hover .photo-image {
    transform: scale(1.03);
  }

  .image-skeleton {
    position: absolute;
    inset: 0;
    background: hsl(var(--muted));
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
  }

  .photo-image:not([src]), .photo-image[src=""] {
    opacity: 0;
  }

  .photo-image:not([src]) + .hover-overlay + .story-overlay + .image-skeleton,
  .photo-image[src=""]:not([src]) + .hover-overlay + .story-overlay + .image-skeleton {
    opacity: 1;
  }

  .skeleton-shimmer {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      90deg,
      transparent 0%,
      hsl(var(--foreground) / 0.05) 50%,
      transparent 100%
    );
    animation: shimmer 1.5s infinite;
  }

  @keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }

  /* ===== Hover Overlay ===== */
  .hover-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      to top,
      hsl(0 0% 0% / 0.7) 0%,
      hsl(0 0% 0% / 0.3) 40%,
      transparent 100%
    );
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    padding: 1.25rem;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .photo-card:hover .hover-overlay {
    opacity: 1;
  }

  .photo-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: white;
    margin: 0;
    text-shadow: 0 1px 3px hsl(0 0% 0% / 0.3);
  }

  .photo-mood {
    font-size: 0.8rem;
    color: hsl(0 0% 100% / 0.85);
    margin-top: 0.25rem;
  }

  /* ===== Story Overlay ===== */
  .story-overlay {
    position: absolute;
    inset: 0;
    background: hsl(0 0% 0% / 0.88);
    backdrop-filter: blur(12px);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 10;
  }

  .story-overlay.active {
    opacity: 1;
    pointer-events: auto;
  }

  .story-content {
    padding: 2rem;
    text-align: center;
    animation: story-appear 0.3s ease-out;
  }

  .story-icon {
    font-size: 2rem;
    margin-bottom: 0.75rem;
  }

  .story-text {
    color: white;
    font-size: 0.9rem;
    line-height: 1.7;
    max-width: 280px;
  }

  @keyframes story-appear {
    from {
      opacity: 0;
      transform: translateY(8px);
    }
  }

  /* ===== Interaction Bar ===== */
  .interaction-bar {
    display: flex;
    gap: 0.5rem;
    padding: 0.875rem 1rem;
    background: hsl(var(--card));
    border-top: 1px solid hsl(var(--border) / 0.5);
  }

  .action-btn {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 0.875rem;
    background: hsl(var(--muted) / 0.5);
    border: 1px solid transparent;
    border-radius: 2rem;
    color: hsl(var(--foreground));
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.25s ease;
  }

  .action-btn:hover {
    background: hsl(var(--muted));
    transform: translateY(-1px);
  }

  .action-btn:active {
    transform: scale(0.96);
  }

  .btn-icon {
    font-size: 1rem;
    transition: transform 0.3s ease;
  }

  .btn-count {
    font-weight: 600;
    min-width: 1rem;
    text-align: center;
  }

  .count-skeleton {
    display: inline-block;
    width: 1rem;
    height: 0.875rem;
    background: hsl(var(--muted));
    border-radius: 0.25rem;
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* Like Button States */
  .like-btn.liked {
    background: hsl(350 80% 50% / 0.15);
    border-color: hsl(350 80% 50% / 0.3);
    color: hsl(350 80% 45%);
  }

  .like-btn.liked .btn-icon {
    animation: heart-pop 0.4s ease;
  }

  @keyframes heart-pop {
    0% { transform: scale(1); }
    25% { transform: scale(1.25); }
    50% { transform: scale(0.95); }
    100% { transform: scale(1); }
  }

  .share-btn {
    margin-left: auto;
  }

  /* ===== Comments Section ===== */
  .comments-section {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.35s ease;
    background: hsl(var(--muted) / 0.2);
  }

  .comments-section.open {
    max-height: 600px;
    overflow-y: auto;
  }

  .comments-list {
    padding: 1rem;
    max-height: 280px;
    overflow-y: auto;
  }

  .comment-item {
    padding: 0.875rem;
    margin-bottom: 0.625rem;
    background: hsl(var(--card));
    border-radius: 0.75rem;
    border-left: 3px solid hsl(var(--primary));
    animation: comment-in 0.3s ease;
  }

  @keyframes comment-in {
    from {
      opacity: 0;
      transform: translateX(-8px);
    }
  }

  .comment-author {
    font-weight: 600;
    font-size: 0.85rem;
    color: hsl(var(--primary));
    margin-bottom: 0.25rem;
  }

  .comment-text {
    font-size: 0.875rem;
    color: hsl(var(--foreground));
    line-height: 1.5;
  }

  .comment-time {
    font-size: 0.7rem;
    color: hsl(var(--muted-foreground));
    margin-top: 0.375rem;
  }

  .empty-comments {
    padding: 2.5rem 1rem;
    text-align: center;
    color: hsl(var(--muted-foreground));
    font-size: 0.875rem;
  }

  /* Comment Form */
  .comment-form {
    padding: 1rem;
    border-top: 1px solid hsl(var(--border) / 0.5);
    display: flex;
    flex-direction: column;
    gap: 0.625rem;
  }

  .form-row {
    display: flex;
  }

  .comment-username,
  .comment-input {
    flex: 1;
    padding: 0.625rem 0.875rem;
    background: hsl(var(--card));
    border: 1px solid hsl(var(--border));
    border-radius: 0.625rem;
    color: hsl(var(--foreground));
    font-size: 0.875rem;
    transition: all 0.2s ease;
  }

  .comment-username:focus,
  .comment-input:focus {
    outline: none;
    border-color: hsl(var(--primary));
    box-shadow: 0 0 0 3px hsl(var(--primary) / 0.1);
  }

  .comment-input {
    resize: none;
    font-family: inherit;
  }

  .comment-submit {
    align-self: flex-end;
    padding: 0.625rem 1.5rem;
    background: linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--primary) / 0.85) 100%);
    color: hsl(var(--primary-foreground));
    border: none;
    border-radius: 2rem;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.25s ease;
  }

  .comment-submit:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px hsl(var(--primary) / 0.3);
  }

  .comment-submit:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .submit-loading {
    display: none;
  }

  .comment-submit.loading .submit-text {
    display: none;
  }

  .comment-submit.loading .submit-loading {
    display: inline;
  }

  /* ===== Empty State ===== */
  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
  }

  .empty-icon {
    font-size: 4rem;
    display: block;
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  .empty-text {
    color: hsl(var(--muted-foreground));
    font-size: 1.1rem;
  }

  /* ===== Particles ===== */
  #particle-container {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 9999;
  }

  :global(.particle) {
    position: absolute;
    pointer-events: none;
    font-size: 1.5rem;
    animation: float-away 2s ease-out forwards;
  }

  @keyframes float-away {
    0% {
      opacity: 1;
      transform: translateY(0) rotate(0deg) scale(1);
    }
    100% {
      opacity: 0;
      transform: translateY(-80px) rotate(180deg) scale(0.5);
    }
  }

  /* ===== Responsive ===== */
  @media (max-width: 640px) {
    .stats-header {
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
    }

    .stat-card {
      flex-direction: column;
      text-align: center;
      padding: 0.75rem;
      gap: 0.25rem;
    }

    .stat-icon {
      font-size: 1.25rem;
    }

    .stat-value {
      font-size: 1.125rem;
    }

    .stat-label {
      font-size: 0.65rem;
    }
  }
</style>

<script>
  import mediumZoom from 'medium-zoom'
  import {
    likePhoto,
    unlikePhoto,
    getAllPhotosStats,
    addComment,
    getComments,
    getCommentCount,
  } from '@/utils/supabase'

  // Debounce helper
  function debounce<T extends (...args: any[]) => void>(fn: T, ms: number) {
    let timer: ReturnType<typeof setTimeout> | null = null
    return (...args: Parameters<T>) => {
      if (timer) clearTimeout(timer)
      timer = setTimeout(() => fn(...args), ms)
    }
  }

  document.addEventListener('DOMContentLoaded', async () => {
    const photoIds = (window as any).__photoIds as string[]

    // ===== Initialize Medium Zoom =====
    const zoom = mediumZoom('[data-zoomable]', {
      margin: 24,
      background: 'hsl(0 0% 0% / 0.9)',
      scrollOffset: 0,
    })

    // ===== Long Press for Story =====
    let pressTimer: number | null = null

    document.querySelectorAll('.photo-card').forEach((card) => {
      const element = card as HTMLElement
      const story = element.dataset.story
      if (!story) return

      const overlay = element.querySelector('.story-overlay') as HTMLElement

      const startPress = (e: Event) => {
        // Don't interfere with zoom
        if ((e.target as HTMLElement).hasAttribute('data-zoomable')) return
        
        e.preventDefault()
        pressTimer = window.setTimeout(() => {
          overlay?.classList.add('active')
          element.style.transform = 'scale(0.98)'
        }, 500)
      }

      const endPress = () => {
        if (pressTimer) {
          clearTimeout(pressTimer)
          pressTimer = null
        }
        overlay?.classList.remove('active')
        element.style.transform = ''
      }

      element.addEventListener('mousedown', startPress)
      element.addEventListener('touchstart', startPress, { passive: false })
      element.addEventListener('mouseup', endPress)
      element.addEventListener('mouseleave', endPress)
      element.addEventListener('touchend', endPress)
      element.addEventListener('touchcancel', endPress)
    })

    // ===== Particle Effects =====
    const createParticles = (x: number, y: number) => {
      const container = document.getElementById('particle-container')
      if (!container) return

      const emojis = ['üçÉ', 'üå∏', 'üçÇ', '‚ú®', 'üå∫', 'üí´']
      const count = Math.floor(Math.random() * 3) + 2

      for (let i = 0; i < count; i++) {
        const particle = document.createElement('div')
        particle.className = 'particle'
        particle.textContent = emojis[Math.floor(Math.random() * emojis.length)]
        particle.style.left = `${x + (Math.random() - 0.5) * 30}px`
        particle.style.top = `${y}px`
        container.appendChild(particle)
        setTimeout(() => particle.remove(), 2000)
      }
    }

    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement
      if (target.hasAttribute('data-zoomable') || target.closest('.action-btn, .comment-form, .medium-zoom-overlay')) return
      createParticles(e.clientX, e.clientY)
    })

    // ===== Load Stats (Batch Query - Only 2 requests!) =====
    const statsMap = await getAllPhotosStats(photoIds)
    
    let totalLikes = 0
    let totalComments = 0

    statsMap.forEach((stats, photoId) => {
      totalLikes += stats.likeCount
      totalComments += stats.commentCount

      const card = document.querySelector(`[data-photo-id="${photoId}"]`) as HTMLElement
      if (!card) return

      const likeBtn = card.querySelector('.like-btn') as HTMLButtonElement
      const likeCount = likeBtn?.querySelector('.like-count')
      const commentCount = card.querySelector('.comment-count')

      if (likeCount) likeCount.textContent = String(stats.likeCount)
      if (commentCount) commentCount.textContent = String(stats.commentCount)
      if (stats.userLiked && likeBtn) likeBtn.classList.add('liked')
    })

    // Update header stats
    document.getElementById('total-likes')!.textContent = String(totalLikes)
    document.getElementById('total-comments')!.textContent = String(totalComments)

    // ===== Username localStorage =====
    const STORAGE_KEY = 'photo_comment_username'
    const savedUsername = localStorage.getItem(STORAGE_KEY) || ''

    document.querySelectorAll('.comment-username').forEach((input) => {
      const el = input as HTMLInputElement
      el.value = savedUsername
    })

    // ===== Like Button Handler =====
    const handleLike = debounce(async (button: HTMLButtonElement) => {
      const photoId = button.dataset.photoId
      if (!photoId) return

      const isLiked = button.classList.contains('liked')
      const countEl = button.querySelector('.like-count') as HTMLElement
      const currentCount = parseInt(countEl.textContent || '0')

      // Optimistic update
      button.classList.toggle('liked')
      countEl.textContent = String(isLiked ? currentCount - 1 : currentCount + 1)

      const updateTotalLikes = (delta: number) => {
        const el = document.getElementById('total-likes')!
        el.textContent = String(parseInt(el.textContent || '0') + delta)
      }

      if (isLiked) {
        await unlikePhoto(photoId)
        updateTotalLikes(-1)
      } else {
        const result = await likePhoto(photoId)
        if (result.alreadyLiked) {
          // Revert optimistic update
          button.classList.add('liked')
          countEl.textContent = String(currentCount)
        } else {
          updateTotalLikes(1)
        }
      }
    }, 300)

    document.querySelectorAll('.like-btn').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation()
        handleLike(e.currentTarget as HTMLButtonElement)
      })
    })

    // ===== Comment Toggle =====
    document.querySelectorAll('.comment-btn').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation()
        const photoId = (e.currentTarget as HTMLButtonElement).dataset.photoId
        if (!photoId) return

        const section = document.querySelector(
          `.comments-section[data-photo-id="${photoId}"]`
        ) as HTMLElement

        if (section.classList.contains('open')) {
          section.classList.remove('open')
        } else {
          section.classList.add('open')
          await loadComments(photoId)
        }
      })
    })

    // ===== Share Button =====
    document.querySelectorAll('.share-btn').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation()
        const photoId = (e.currentTarget as HTMLElement).dataset.photoId
        const url = `${window.location.origin}/photos#photo-${photoId}`

        if (navigator.share) {
          await navigator.share({ title: 'ÂàÜ‰∫´ÁÖßÁâá', url })
        } else {
          await navigator.clipboard.writeText(url)
          // Simple feedback
          const icon = (e.currentTarget as HTMLElement).querySelector('.btn-icon')!
          icon.textContent = '‚úÖ'
          setTimeout(() => (icon.textContent = 'üì§'), 1500)
        }
      })
    })

    // ===== Comment Form =====
    document.querySelectorAll('.comment-form').forEach((form) => {
      form.addEventListener('submit', async (e) => {
        e.preventDefault()
        const formEl = e.currentTarget as HTMLFormElement
        const photoId = formEl.closest('.comments-section')?.getAttribute('data-photo-id')
        if (!photoId) return

        const usernameInput = formEl.querySelector('.comment-username') as HTMLInputElement
        const commentInput = formEl.querySelector('.comment-input') as HTMLTextAreaElement
        const submitBtn = formEl.querySelector('.comment-submit') as HTMLButtonElement

        const username = usernameInput.value.trim()
        const comment = commentInput.value.trim()
        if (!username || !comment) return

        // Save username
        localStorage.setItem(STORAGE_KEY, username)

        // Show loading
        submitBtn.disabled = true
        submitBtn.classList.add('loading')

        const { error } = await addComment(photoId, username, comment)

        if (error) {
          alert('ËØÑËÆ∫ÂèëÈÄÅÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï')
        } else {
          commentInput.value = ''
          await loadComments(photoId)

          // Update counts
          const { count } = await getCommentCount(photoId)
          const countEl = document.querySelector(
            `.comment-btn[data-photo-id="${photoId}"] .comment-count`
          )
          if (countEl) countEl.textContent = String(count)

          const totalEl = document.getElementById('total-comments')!
          totalEl.textContent = String(parseInt(totalEl.textContent || '0') + 1)
        }

        submitBtn.disabled = false
        submitBtn.classList.remove('loading')
      })
    })
  })

  // ===== Load Comments =====
  async function loadComments(photoId: string) {
    const { data: comments } = await getComments(photoId)
    const list = document.querySelector(
      `.comments-section[data-photo-id="${photoId}"] .comments-list`
    ) as HTMLElement

    if (!list) return

    if (comments.length === 0) {
      list.innerHTML = '<div class="empty-comments">ËøòÊ≤°ÊúâËØÑËÆ∫ÔºåÊù•Êä¢Ê≤ôÂèëÂêßÔºÅ üõãÔ∏è</div>'
      return
    }

    list.innerHTML = comments
      .map(
        (c: { username: string; comment: string; created_at: string }) => `
        <div class="comment-item">
          <div class="comment-author">${escapeHtml(c.username)}</div>
          <div class="comment-text">${escapeHtml(c.comment)}</div>
          <div class="comment-time">${getTimeAgo(new Date(c.created_at))}</div>
        </div>
      `
      )
      .join('')
  }

  function getTimeAgo(date: Date): string {
    const s = Math.floor((Date.now() - date.getTime()) / 1000)
    if (s < 60) return 'ÂàöÂàö'
    if (s < 3600) return `${Math.floor(s / 60)} ÂàÜÈíüÂâç`
    if (s < 86400) return `${Math.floor(s / 3600)} Â∞èÊó∂Ââç`
    if (s < 2592000) return `${Math.floor(s / 86400)} Â§©Ââç`
    return date.toLocaleDateString('zh-CN')
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div')
    div.textContent = text
    return div.innerHTML
  }
</script>
