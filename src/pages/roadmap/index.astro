---
import PageLayout from '@/layouts/CommonPage.astro'
import RoadmapDrawer from '@/components/roadmap/RoadmapDrawer.astro'
import ActivityGraph from '@/components/roadmap/ActivityGraph.astro'

type Topic = {
  title: string
  prerequisites: { name: string; course: string }[]
  problems: { name: string; difficulty: string; link: string }[]
}

const topics: Record<string, Topic> = {
  'sliding-window-two-pointers': {
    title: '滑动窗口与双指针',
    prerequisites: [],
    problems: []
  },
  'binary-search': {
    title: '二分算法',
    prerequisites: [],
    problems: []
  },
  'monotonic-stack': {
    title: '单调栈',
    prerequisites: [],
    problems: []
  },
  'grid-graph': {
    title: '网格图',
    prerequisites: [],
    problems: []
  },
  'bit-manipulation': {
    title: '位运算',
    prerequisites: [],
    problems: []
  },
  'graph-algorithms': {
    title: '图论算法',
    prerequisites: [],
    problems: []
  },
  'dynamic-programming': {
    title: '动态规划',
    prerequisites: [],
    problems: []
  },
  'data-structures': {
    title: '常用数据结构',
    prerequisites: [],
    problems: []
  },
  'math': {
    title: '数学算法',
    prerequisites: [],
    problems: []
  },
  'greedy-thinking': {
    title: '贪心与思维',
    prerequisites: [],
    problems: []
  },
  'linked-list-tree-backtracking': {
    title: '链表、二叉树与回溯',
    prerequisites: [],
    problems: []
  },
  'strings': {
    title: '字符串',
    prerequisites: [],
    problems: []
  }
}

const nodes = [
  { id: 'sliding-window-two-pointers', x: 400, y: 50 },
  { id: 'binary-search', x: 150, y: 200 },
  { id: 'linked-list-tree-backtracking', x: 650, y: 200 },
  { id: 'monotonic-stack', x: 150, y: 350 },
  { id: 'data-structures', x: 400, y: 350 },
  { id: 'strings', x: 650, y: 350 },
  { id: 'grid-graph', x: 150, y: 500 },
  { id: 'graph-algorithms', x: 400, y: 500 },
  { id: 'greedy-thinking', x: 650, y: 500 },
  { id: 'math', x: 150, y: 650 },
  { id: 'bit-manipulation', x: 400, y: 650 },
  { id: 'dynamic-programming', x: 400, y: 800 }
]

const edges = [
  ['sliding-window-two-pointers', 'binary-search'],
  ['sliding-window-two-pointers', 'linked-list-tree-backtracking'],
  ['binary-search', 'monotonic-stack'],
  ['linked-list-tree-backtracking', 'data-structures'],
  ['linked-list-tree-backtracking', 'strings'],
  ['monotonic-stack', 'grid-graph'],
  ['data-structures', 'graph-algorithms'],
  ['strings', 'greedy-thinking'],
  ['grid-graph', 'graph-algorithms'],
  ['graph-algorithms', 'math'],
  ['graph-algorithms', 'bit-manipulation'],
  ['math', 'dynamic-programming'],
  ['bit-manipulation', 'dynamic-programming'],
  ['greedy-thinking', 'dynamic-programming']
]

const headings = [{ depth: 2, slug: 'roadmap', text: 'Algorithm Roadmap' }]
---

<PageLayout title='Algorithm Roadmap' {headings}>
  <p class='mb-6 text-muted-foreground'>
    点击节点查看题目列表，参考
    <a href='https://leetcode.cn/discuss/post/RvFUtj/' target='_blank' class='text-primary hover:underline'>灵茶山艾府 - 算法竞赛模板库</a>。
  </p>

  <div class='roadmap-container'>
    <!-- Mini-map and controls -->
    <div class='roadmap-controls'>
      <div class='mini-map'>
        <svg class='mini-map-svg' viewBox='0 0 1000 1200' xmlns='http://www.w3.org/2000/svg'>
          {edges.map(([from, to]) => {
            const a = nodes.find(n => n.id === from)
            const b = nodes.find(n => n.id === to)
            if (!a || !b) return null
            const rectW = 180, rectH = 64
            const x1 = a.x + rectW / 2, y1 = a.y + rectH / 2
            const x2 = b.x + rectW / 2, y2 = b.y
            return <line x1={x1} y1={y1} x2={x2} y2={y2} stroke='#475569' stroke-width='6' />
          })}
          {nodes.map(n => (
            <rect x={n.x} y={n.y} width='180' height='64' rx='8' fill='#334155' stroke='#60a5fa' stroke-width='4' />
          ))}
          <rect id='mini-viewport' class='mini-viewport' x='0' y='0' width='1000' height='900' fill='rgba(96, 165, 250, 0.15)' stroke='#60a5fa' stroke-width='8' />
        </svg>
      </div>
      <button id='reset-btn' class='reset-btn' title='Reset View'>
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
        <span>Reset</span>
      </button>
      <div class='zoom-info' id='zoom-info'>100%</div>
      <div class='zoom-btns'>
        <button id='zoom-in' class='zoom-btn' title='Zoom In'>+</button>
        <button id='zoom-out' class='zoom-btn' title='Zoom Out'>-</button>
      </div>
    </div>

    <div class='roadmap-box'>
      <svg class='roadmap-svg' viewBox='0 0 1000 1200' xmlns='http://www.w3.org/2000/svg'>
        <g id='canvas' transform='translate(0,0) scale(1)'>
        {edges.map(([from, to]) => {
          const a = nodes.find(n => n.id === from)
          const b = nodes.find(n => n.id === to)
          if (!a || !b) return null
          const rectW = 180, rectH = 64
          const x1 = a.x + rectW / 2, y1 = a.y + rectH / 2
          const x2 = b.x + rectW / 2, y2 = b.y
          const cy = (y1 + y2) / 2
          return <path d={`M${x1} ${y1} C${x1} ${cy}, ${x2} ${cy}, ${x2} ${y2}`} class='edge-line' />
        })}
        {nodes.map(n => (
          <g class='node-box' data-id={n.id} transform={`translate(${n.x},${n.y})`}>
            <rect width='180' height='64' rx='12' />
            <rect class='node-progress' x='0' y='60' width='0' height='4' rx='2' />
            <text x='90' y='38'>{topics[n.id].title}</text>
          </g>
        ))}
      </g>
    </svg>
  </div>
</div>

  <RoadmapDrawer topics={topics} />

  <!-- Activity Graph -->
  <div class='mt-12 mb-8'>
    <h2 class='text-2xl font-bold mb-4'>Activity</h2>
    <div class='border rounded-xl p-4 bg-card'>
      <ActivityGraph />
    </div>
  </div>

  <!-- List View Section -->
  <div class='mt-12'>
    <h2 class='text-2xl font-bold mb-6'>All Topics</h2>
    <div class='grid gap-6 sm:grid-cols-2 lg:grid-cols-3'>
      {Object.entries(topics).map(([id, topic]) => (
        <div class='topic-card border rounded-xl p-4 bg-card hover:shadow-md transition-shadow' data-id={id}>
          <h3 class='text-lg font-semibold mb-2'>{topic.title}</h3>
          <div class='text-sm text-muted-foreground mb-3'>
            {topic.problems.length} Problems
          </div>
          <div class='bar-track h-2 mb-3 bg-muted rounded-full overflow-hidden'><div class='bar-fill list-progress-bar h-full bg-primary transition-all duration-500' data-id={id} style='width: 0%'></div></div>
          <button class='text-primary text-sm font-medium hover:underline open-topic-btn' data-id={id}>
            View Problems →
          </button>
        </div>
      ))}
    </div>
  </div>
</PageLayout>

<script define:vars={{ topics }} is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    // Open Drawer Helper
    function open(id) {
      if (window.openRoadmapDrawer) {
        window.openRoadmapDrawer(id)
      }
    }

    document.querySelectorAll('.node-box').forEach(el => {
      el.addEventListener('click', (evt) => {
        evt.stopPropagation()
        open(el.dataset.id)
      })
    })

    document.querySelectorAll('.open-topic-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        open(btn.dataset.id)
      })
    })

    // Panning / Dragging the canvas
    const svg = document.querySelector('.roadmap-svg')
    const canvas = document.getElementById('canvas')
    const miniViewport = document.getElementById('mini-viewport')
    const resetBtn = document.getElementById('reset-btn')
    const zoomInfo = document.getElementById('zoom-info')
    const zoomInBtn = document.getElementById('zoom-in')
    const zoomOutBtn = document.getElementById('zoom-out')
    
    let isPanning = false
    let startX = 0, startY = 0
    let panX = 0, panY = 0
    let scale = 1
    const minScale = 0.3, maxScale = 2.5

    function updateTransform() {
      canvas.setAttribute('transform', `translate(${panX},${panY}) scale(${scale})`)
      zoomInfo.textContent = `${Math.round(scale * 100)}%`
      updateMiniMap()
    }

    function zoom(delta) {
      scale = Math.min(maxScale, Math.max(minScale, scale * delta))
      
      // Zoom towards center of viewport
      const rect = svg.getBoundingClientRect()
      const centerX = rect.width / 2
      const centerY = rect.height / 2
      
      // Adjust pan to keep center fixed
      panX = centerX - (centerX - panX) * (scale / oldScale)
      panY = centerY - (centerY - panY) * (scale / oldScale)
      
      updateTransform()
    }

    zoomInBtn.addEventListener('click', () => zoom(1.2))
    zoomOutBtn.addEventListener('click', () => zoom(0.8))

    function updateMiniMap() {
      if (!miniViewport) return
      // viewport in SVG coordinates
      const vw = 1000 / scale
      const vh = 1200 / scale
      const vx = -panX / scale
      const vy = -panY / scale
      miniViewport.setAttribute('x', vx)
      miniViewport.setAttribute('y', vy)
      miniViewport.setAttribute('width', vw)
      miniViewport.setAttribute('height', vh)
    }

    function resetView() {
      panX = 0
      panY = 0
      scale = 1
      updateTransform()
    }

    resetBtn.addEventListener('click', resetView)

    svg.style.cursor = 'grab'

    svg.addEventListener('mousedown', (e) => {
      if (e.button !== 0) return
      // prevent panning when clicking node (nodes stopPropagation above)
      isPanning = true
      startX = e.clientX
      startY = e.clientY
      svg.style.cursor = 'grabbing'
    })

    document.addEventListener('mousemove', (e) => {
      if (!isPanning) return
      const dx = e.clientX - startX
      const dy = e.clientY - startY
      canvas.setAttribute('transform', `translate(${panX + dx},${panY + dy}) scale(${scale})`)
      updateMiniMap()
    })

    document.addEventListener('mouseup', (e) => {
      if (!isPanning) return
      const dx = e.clientX - startX
      const dy = e.clientY - startY
      panX += dx
      panY += dy
      isPanning = false
      svg.style.cursor = 'grab'
      updateMiniMap()
    })

    // Zoom with Ctrl+Wheel
    svg.addEventListener('wheel', (e) => {
      if (!e.ctrlKey) return
      e.preventDefault()
      const rect = svg.getBoundingClientRect()
      const mouseX = e.clientX - rect.left
      const mouseY = e.clientY - rect.top
      
      // Convert mouse position to SVG coordinates
      const svgX = (mouseX / rect.width) * 1000
      const svgY = (mouseY / rect.height) * 1200
      
      const oldScale = scale
      const delta = e.deltaY > 0 ? 0.9 : 1.1
      scale = Math.min(maxScale, Math.max(minScale, scale * delta))
      
      // Adjust pan to zoom towards mouse position
      panX = panX - (svgX - panX / oldScale) * (scale - oldScale)
      panY = panY - (svgY - panY / oldScale) * (scale - oldScale)
      
      updateTransform()
    }, { passive: false })

    // Touch support
    // Touch support for panning and pinch-zoom
    let lastTouchDist = 0
    let lastTouchCenter = { x: 0, y: 0 }
    
    svg.addEventListener('touchstart', (e) => {
      if (e.touches.length === 1) {
        isPanning = true
        startX = e.touches[0].clientX
        startY = e.touches[0].clientY
      } else if (e.touches.length === 2) {
        isPanning = false
        const t1 = e.touches[0], t2 = e.touches[1]
        lastTouchDist = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY)
        lastTouchCenter = { x: (t1.clientX + t2.clientX) / 2, y: (t1.clientY + t2.clientY) / 2 }
      }
    }, { passive: true })

    document.addEventListener('touchmove', (e) => {
      if (e.touches.length === 1 && isPanning) {
        const dx = e.touches[0].clientX - startX
        const dy = e.touches[0].clientY - startY
        canvas.setAttribute('transform', `translate(${panX + dx},${panY + dy}) scale(${scale})`)
        updateMiniMap()
      } else if (e.touches.length === 2) {
        const t1 = e.touches[0], t2 = e.touches[1]
        const dist = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY)
        const center = { x: (t1.clientX + t2.clientX) / 2, y: (t1.clientY + t2.clientY) / 2 }
        
        // Pinch zoom
        if (lastTouchDist > 0) {
          const delta = dist / lastTouchDist
          const oldScale = scale
          scale = Math.min(maxScale, Math.max(minScale, scale * delta))
          
          // Pan while zooming
          const dx = center.x - lastTouchCenter.x
          const dy = center.y - lastTouchCenter.y
          panX += dx
          panY += dy
          
          updateTransform()
        }
        lastTouchDist = dist
        lastTouchCenter = center
      }
    }, { passive: true })

    document.addEventListener('touchend', (e) => {
      if (e.touches.length < 2) {
        lastTouchDist = 0
      }
      if (e.touches.length === 0 && isPanning) {
        // Finalize panning
        const matrix = canvas.getAttribute('transform') || 'translate(0,0) scale(1)'
        const m = matrix.match(/translate\(([-0-9.]+),([-0-9.]+)\)/)
        if (m) { panX = parseFloat(m[1]); panY = parseFloat(m[2]) }
        isPanning = false
      }
    })
  })
</script>
<style>
  /* Roadmap Container */
  .roadmap-container {
    position: relative;
  }

  .roadmap-controls {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    z-index: 10;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    align-items: flex-end;
  }

  .mini-map {
    width: 150px;
    height: 180px;
    background: hsl(var(--card));
    border: 1px solid hsl(var(--border));
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }

  .mini-map-svg {
    width: 100%;
    height: 100%;
    background: hsl(var(--muted));
  }

  .mini-viewport {
    pointer-events: none;
  }

  .reset-btn {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 0.75rem;
    background: hsl(var(--primary));
    color: hsl(var(--primary-foreground));
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: opacity 0.2s;
  }
  .reset-btn:hover { opacity: 0.85; }

  .zoom-info {
    background: hsl(var(--muted));
    color: hsl(var(--muted-foreground));
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    border: 1px solid hsl(var(--border));
  }

  .zoom-btns {
    display: flex;
    gap: 0.25rem;
  }
  .zoom-btn {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: hsl(var(--card));
    border: 1px solid hsl(var(--border));
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    color: hsl(var(--foreground));
    transition: all 0.2s;
  }
  .zoom-btn:hover {
    background: hsl(var(--muted));
    border-color: hsl(var(--primary));
    color: hsl(var(--primary));
  }

  /* Roadmap Box */
  .roadmap-box {
    border-radius: 12px;
    background: linear-gradient(135deg, hsl(var(--muted)) 0%, hsl(var(--card)) 100%);
    border: 1px solid hsl(var(--border));
    overflow: hidden;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
  }

  .roadmap-svg {
    width: 100%;
    height: 600px;
    display: block;
    touch-action: none;
    user-select: none;
  }

  /* Edge Lines */
  .edge-line {
    stroke: hsl(var(--muted-foreground) / 0.4);
    stroke-width: 2.5;
    fill: none;
  }

  /* Node Boxes */
  .node-box rect {
    fill: hsl(var(--card));
    stroke: hsl(var(--primary));
    stroke-width: 2;
    transition: all 0.2s ease;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.15));
  }
  .node-box:hover rect {
    fill: hsl(var(--primary) / 0.15);
    stroke-width: 3;
    filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.25));
  }
  .node-box {
    cursor: pointer;
  }
  .node-box text {
    fill: hsl(var(--foreground));
    font-size: 14px;
    font-weight: 600;
    text-anchor: middle;
    dominant-baseline: middle;
    pointer-events: none;
  }

    /* Responsive */
    @media (max-width: 640px) {
      .roadmap-controls {
        top: 0.25rem;
        right: 0.25rem;
      }
      .mini-map {
        width: 100px;
        height: 120px;
      }
      .reset-btn span { display: none; }
      .reset-btn { padding: 0.5rem; }
    }
  </style>
