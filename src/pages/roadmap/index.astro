---
import PageLayout from '@/layouts/CommonPage.astro'

type Topic = {
  title: string
  prerequisites: { name: string; course: string }[]
  problems: { name: string; difficulty: string; link: string }[]
}

const topics: Record<string, Topic> = {
  'arrays-hashing': {
    title: 'Arrays & Hashing',
    prerequisites: [
      { name: 'Dynamic Arrays', course: 'DSA for Beginners' },
      { name: 'Hash Tables', course: 'DSA for Beginners' }
    ],
    problems: [
      { name: 'Contains Duplicate', difficulty: 'Easy', link: 'https://leetcode.com/problems/contains-duplicate/' },
      { name: 'Valid Anagram', difficulty: 'Easy', link: 'https://leetcode.com/problems/valid-anagram/' },
      { name: 'Two Sum', difficulty: 'Easy', link: 'https://leetcode.com/problems/two-sum/' },
      { name: 'Group Anagrams', difficulty: 'Medium', link: 'https://leetcode.com/problems/group-anagrams/' },
      { name: 'Top K Frequent Elements', difficulty: 'Medium', link: 'https://leetcode.com/problems/top-k-frequent-elements/' },
      { name: 'Product of Array Except Self', difficulty: 'Medium', link: 'https://leetcode.com/problems/product-of-array-except-self/' },
      { name: 'Valid Sudoku', difficulty: 'Medium', link: 'https://leetcode.com/problems/valid-sudoku/' },
      { name: 'Longest Consecutive Sequence', difficulty: 'Medium', link: 'https://leetcode.com/problems/longest-consecutive-sequence/' }
    ]
  },
  'two-pointers': {
    title: 'Two Pointers',
    prerequisites: [{ name: 'Pointer Techniques', course: 'DSA for Beginners' }],
    problems: [
      { name: 'Valid Palindrome', difficulty: 'Easy', link: 'https://leetcode.com/problems/valid-palindrome/' },
      { name: 'Two Sum II', difficulty: 'Medium', link: 'https://leetcode.com/problems/two-sum-ii-input-array-is-sorted/' },
      { name: '3Sum', difficulty: 'Medium', link: 'https://leetcode.com/problems/3sum/' },
      { name: 'Container With Most Water', difficulty: 'Medium', link: 'https://leetcode.com/problems/container-with-most-water/' },
      { name: 'Trapping Rain Water', difficulty: 'Hard', link: 'https://leetcode.com/problems/trapping-rain-water/' }
    ]
  },
  'stack': {
    title: 'Stack',
    prerequisites: [{ name: 'Call Stack', course: 'DSA for Beginners' }],
    problems: [
      { name: 'Valid Parentheses', difficulty: 'Easy', link: 'https://leetcode.com/problems/valid-parentheses/' },
      { name: 'Min Stack', difficulty: 'Medium', link: 'https://leetcode.com/problems/min-stack/' },
      { name: 'Daily Temperatures', difficulty: 'Medium', link: 'https://leetcode.com/problems/daily-temperatures/' },
      { name: 'Largest Rectangle in Histogram', difficulty: 'Hard', link: 'https://leetcode.com/problems/largest-rectangle-in-histogram/' }
    ]
  },
  'binary-search': {
    title: 'Binary Search',
    prerequisites: [{ name: 'Sorted Arrays', course: 'DSA for Beginners' }],
    problems: [
      { name: 'Binary Search', difficulty: 'Easy', link: 'https://leetcode.com/problems/binary-search/' },
      { name: 'Search 2D Matrix', difficulty: 'Medium', link: 'https://leetcode.com/problems/search-a-2d-matrix/' },
      { name: 'Koko Eating Bananas', difficulty: 'Medium', link: 'https://leetcode.com/problems/koko-eating-bananas/' },
      { name: 'Median of Two Sorted Arrays', difficulty: 'Hard', link: 'https://leetcode.com/problems/median-of-two-sorted-arrays/' }
    ]
  },
  'sliding-window': {
    title: 'Sliding Window',
    prerequisites: [{ name: 'Window Basics', course: 'Advanced Algorithms' }],
    problems: [
      { name: 'Best Time to Buy and Sell Stock', difficulty: 'Easy', link: 'https://leetcode.com/problems/best-time-to-buy-and-sell-stock/' },
      { name: 'Longest Substring Without Repeating', difficulty: 'Medium', link: 'https://leetcode.com/problems/longest-substring-without-repeating-characters/' },
      { name: 'Minimum Window Substring', difficulty: 'Hard', link: 'https://leetcode.com/problems/minimum-window-substring/' }
    ]
  },
  'linked-list': {
    title: 'Linked List',
    prerequisites: [{ name: 'Pointers', course: 'DSA for Beginners' }],
    problems: [
      { name: 'Reverse Linked List', difficulty: 'Easy', link: 'https://leetcode.com/problems/reverse-linked-list/' },
      { name: 'Linked List Cycle', difficulty: 'Easy', link: 'https://leetcode.com/problems/linked-list-cycle/' },
      { name: 'Reorder List', difficulty: 'Medium', link: 'https://leetcode.com/problems/reorder-list/' },
      { name: 'LRU Cache', difficulty: 'Medium', link: 'https://leetcode.com/problems/lru-cache/' },
      { name: 'Merge K Sorted Lists', difficulty: 'Hard', link: 'https://leetcode.com/problems/merge-k-sorted-lists/' }
    ]
  },
  'trees': {
    title: 'Trees',
    prerequisites: [{ name: 'DFS / BFS', course: 'DSA for Beginners' }],
    problems: [
      { name: 'Invert Binary Tree', difficulty: 'Easy', link: 'https://leetcode.com/problems/invert-binary-tree/' },
      { name: 'Validate BST', difficulty: 'Medium', link: 'https://leetcode.com/problems/validate-binary-search-tree/' },
      { name: 'Binary Tree Maximum Path Sum', difficulty: 'Hard', link: 'https://leetcode.com/problems/binary-tree-maximum-path-sum/' }
    ]
  },
  'tries': {
    title: 'Tries',
    prerequisites: [{ name: 'Prefix Trees', course: 'Advanced Algorithms' }],
    problems: [
      { name: 'Implement Trie', difficulty: 'Medium', link: 'https://leetcode.com/problems/implement-trie-prefix-tree/' },
      { name: 'Word Search II', difficulty: 'Hard', link: 'https://leetcode.com/problems/word-search-ii/' }
    ]
  },
  'heap': {
    title: 'Heap / Priority Queue',
    prerequisites: [{ name: 'Binary Heap', course: 'DSA for Beginners' }],
    problems: [
      { name: 'K Closest Points', difficulty: 'Medium', link: 'https://leetcode.com/problems/k-closest-points-to-origin/' },
      { name: 'Find Median from Data Stream', difficulty: 'Hard', link: 'https://leetcode.com/problems/find-median-from-data-stream/' }
    ]
  },
  'backtracking': {
    title: 'Backtracking',
    prerequisites: [{ name: 'Subsets & Permutations', course: 'Advanced Algorithms' }],
    problems: [
      { name: 'Subsets', difficulty: 'Medium', link: 'https://leetcode.com/problems/subsets/' },
      { name: 'Combination Sum', difficulty: 'Medium', link: 'https://leetcode.com/problems/combination-sum/' },
      { name: 'N-Queens', difficulty: 'Hard', link: 'https://leetcode.com/problems/n-queens/' }
    ]
  },
  'graphs': {
    title: 'Graphs',
    prerequisites: [{ name: 'Adjacency List', course: 'DSA for Beginners' }],
    problems: [
      { name: 'Number of Islands', difficulty: 'Medium', link: 'https://leetcode.com/problems/number-of-islands/' },
      { name: 'Course Schedule', difficulty: 'Medium', link: 'https://leetcode.com/problems/course-schedule/' },
      { name: 'Word Ladder', difficulty: 'Hard', link: 'https://leetcode.com/problems/word-ladder/' }
    ]
  },
  '1d-dp': {
    title: '1-D DP',
    prerequisites: [{ name: 'Memoization', course: 'Advanced Algorithms' }],
    problems: [
      { name: 'Climbing Stairs', difficulty: 'Easy', link: 'https://leetcode.com/problems/climbing-stairs/' },
      { name: 'House Robber', difficulty: 'Medium', link: 'https://leetcode.com/problems/house-robber/' },
      { name: 'Longest Increasing Subsequence', difficulty: 'Medium', link: 'https://leetcode.com/problems/longest-increasing-subsequence/' }
    ]
  },
  'intervals': {
    title: 'Intervals',
    prerequisites: [{ name: 'Sorting', course: 'Advanced Algorithms' }],
    problems: [
      { name: 'Merge Intervals', difficulty: 'Medium', link: 'https://leetcode.com/problems/merge-intervals/' },
      { name: 'Meeting Rooms II', difficulty: 'Medium', link: 'https://leetcode.com/problems/meeting-rooms-ii/' }
    ]
  },
  'greedy': {
    title: 'Greedy',
    prerequisites: [{ name: 'Greedy Strategy', course: 'Advanced Algorithms' }],
    problems: [
      { name: 'Jump Game', difficulty: 'Medium', link: 'https://leetcode.com/problems/jump-game/' },
      { name: 'Gas Station', difficulty: 'Medium', link: 'https://leetcode.com/problems/gas-station/' }
    ]
  },
  'advanced-graphs': {
    title: 'Advanced Graphs',
    prerequisites: [{ name: 'Dijkstra', course: 'Advanced Algorithms' }],
    problems: [
      { name: 'Network Delay Time', difficulty: 'Medium', link: 'https://leetcode.com/problems/network-delay-time/' },
      { name: 'Swim in Rising Water', difficulty: 'Hard', link: 'https://leetcode.com/problems/swim-in-rising-water/' }
    ]
  },
  '2d-dp': {
    title: '2-D DP',
    prerequisites: [{ name: 'Knapsack', course: 'Advanced Algorithms' }],
    problems: [
      { name: 'Unique Paths', difficulty: 'Medium', link: 'https://leetcode.com/problems/unique-paths/' },
      { name: 'Edit Distance', difficulty: 'Hard', link: 'https://leetcode.com/problems/edit-distance/' }
    ]
  },
  'bit-manipulation': {
    title: 'Bit Manipulation',
    prerequisites: [{ name: 'Bitwise Ops', course: 'Advanced Algorithms' }],
    problems: [
      { name: 'Single Number', difficulty: 'Easy', link: 'https://leetcode.com/problems/single-number/' },
      { name: 'Reverse Integer', difficulty: 'Medium', link: 'https://leetcode.com/problems/reverse-integer/' }
    ]
  },
  'math-geometry': {
    title: 'Math & Geometry',
    prerequisites: [{ name: 'Matrix Ops', course: 'Advanced Algorithms' }],
    problems: [
      { name: 'Rotate Image', difficulty: 'Medium', link: 'https://leetcode.com/problems/rotate-image/' },
      { name: 'Spiral Matrix', difficulty: 'Medium', link: 'https://leetcode.com/problems/spiral-matrix/' }
    ]
  }
}

const nodes = [
  { id: 'arrays-hashing', x: 350, y: 30 },
  { id: 'two-pointers', x: 200, y: 160 },
  { id: 'stack', x: 500, y: 160 },
  { id: 'binary-search', x: 80, y: 290 },
  { id: 'sliding-window', x: 350, y: 290 },
  { id: 'linked-list', x: 620, y: 290 },
  { id: 'trees', x: 350, y: 420 },
  { id: 'tries', x: 180, y: 550 },
  { id: 'backtracking', x: 520, y: 550 },
  { id: 'heap', x: 80, y: 680 },
  { id: 'graphs', x: 350, y: 680 },
  { id: '1d-dp', x: 620, y: 680 },
  { id: 'intervals', x: 50, y: 810 },
  { id: 'greedy', x: 200, y: 810 },
  { id: 'advanced-graphs', x: 350, y: 810 },
  { id: '2d-dp', x: 500, y: 810 },
  { id: 'bit-manipulation', x: 650, y: 810 },
  { id: 'math-geometry', x: 500, y: 940 }
]

const edges = [
  ['arrays-hashing', 'two-pointers'],
  ['arrays-hashing', 'stack'],
  ['two-pointers', 'binary-search'],
  ['two-pointers', 'sliding-window'],
  ['stack', 'sliding-window'],
  ['stack', 'linked-list'],
  ['binary-search', 'trees'],
  ['sliding-window', 'trees'],
  ['linked-list', 'trees'],
  ['trees', 'tries'],
  ['trees', 'backtracking'],
  ['tries', 'heap'],
  ['backtracking', 'graphs'],
  ['backtracking', '1d-dp'],
  ['heap', 'intervals'],
  ['heap', 'greedy'],
  ['heap', 'advanced-graphs'],
  ['graphs', 'advanced-graphs'],
  ['graphs', '2d-dp'],
  ['1d-dp', '2d-dp'],
  ['1d-dp', 'bit-manipulation'],
  ['2d-dp', 'math-geometry']
]

const headings = [{ depth: 2, slug: 'roadmap', text: 'Algorithm Roadmap' }]
---

<PageLayout title='Algorithm Roadmap' {headings}>
  <p class='mb-6 text-muted-foreground'>
    点击节点查看题目列表，参考
    <a href='https://neetcode.io/roadmap' target='_blank' class='text-primary hover:underline'>NeetCode</a>。
  </p>

  <div class='roadmap-box'>
    <svg class='roadmap-svg' viewBox='0 0 800 1050'>
      {edges.map(([from, to]) => {
        const a = nodes.find(n => n.id === from)
        const b = nodes.find(n => n.id === to)
        if (!a || !b) return null
        const x1 = a.x + 75, y1 = a.y + 25
        const x2 = b.x + 75, y2 = b.y
        const cy = (y1 + y2) / 2
        return <path d={`M${x1} ${y1} C${x1} ${cy}, ${x2} ${cy}, ${x2} ${y2}`} class='edge-line' />
      })}
      {nodes.map(n => (
        <g class='node-box' data-id={n.id} transform={`translate(${n.x},${n.y})`}>
          <rect width='150' height='50' rx='10' />
          <text x='75' y='30'>{topics[n.id].title}</text>
        </g>
      ))}
    </svg>
  </div>

  <div id='modal' class='modal hidden'>
    <div class='modal-inner'>
      <button id='close-btn' class='close-btn'>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
      <h2 id='modal-title'></h2>
      <p id='modal-count' class='count-text'></p>
      <div class='bar-track'><div id='bar-fill' class='bar-fill'></div></div>
      <h3>Prerequisites</h3>
      <div id='prereq-box' class='prereq-box'></div>
      <table class='prob-table'>
        <thead><tr><th></th><th></th><th>Problem</th><th>Difficulty</th></tr></thead>
        <tbody id='prob-body'></tbody>
      </table>
    </div>
  </div>
</PageLayout>

<script define:vars={{ topics }}>
  document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('modal')
    const closeBtn = document.getElementById('close-btn')
    const titleEl = document.getElementById('modal-title')
    const countEl = document.getElementById('modal-count')
    const barFill = document.getElementById('bar-fill')
    const prereqBox = document.getElementById('prereq-box')
    const probBody = document.getElementById('prob-body')

    // LocalStorage Key
    const STORAGE_KEY = 'algo-roadmap-progress'
    let progress = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}')

    function save() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(progress))
    }

    function updateProgress(topicId) {
      const total = topics[topicId].problems.length
      const completed = topics[topicId].problems.filter(p => progress[p.link]).length
      const percent = total === 0 ? 0 : Math.round((completed / total) * 100)
      
      countEl.textContent = `${completed} / ${total} (${percent}%)`
      barFill.style.width = `${percent}%`
    }

    function open(id) {
      const d = topics[id]
      if (!d) return
      
      modal.dataset.activeTopic = id
      titleEl.textContent = d.title
      
      prereqBox.innerHTML = d.prerequisites.map(p => 
        `<div class='prereq-card'><b>${p.name}</b><small>${p.course}</small></div>`
      ).join('')
      
      probBody.innerHTML = d.problems.map(p => {
        const isChecked = progress[p.link] ? 'checked' : ''
        return `
        <tr>
          <td><input type='checkbox' class='prob-check' data-link='${p.link}' ${isChecked}/></td>
          <td class='star'>
             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
          </td>
          <td><a href='${p.link}' target='_blank'>${p.name}</a></td>
          <td class='diff diff-${p.difficulty.toLowerCase()}'>${p.difficulty}</td>
        </tr>
      `}).join('')
      
      updateProgress(id)
      modal.classList.remove('hidden')
    }

    // Event Delegation for Checkboxes
    probBody.addEventListener('change', (e) => {
      if (e.target.classList.contains('prob-check')) {
        const link = e.target.dataset.link
        if (e.target.checked) {
          progress[link] = true
        } else {
          delete progress[link]
        }
        save()
        updateProgress(modal.dataset.activeTopic)
      }
    })

    document.querySelectorAll('.node-box').forEach(el => {
      el.addEventListener('click', () => open(el.dataset.id))
    })

    function close() { modal.classList.add('hidden') }
    closeBtn.addEventListener('click', close)
    modal.addEventListener('click', e => { if (e.target === modal) close() })
    document.addEventListener('keydown', e => { if (e.key === 'Escape') close() })
  })
</script>

<style>
  .roadmap-box { 
    overflow-x: auto; 
    padding: 2rem; 
    border: 1px solid #475569; 
    border-radius: 1rem; 
    background-color: #1e293b;
    background-image: radial-gradient(#475569 1px, transparent 1px);
    background-size: 24px 24px;
  }
  .roadmap-svg { min-width: 800px; display: block; margin: 0 auto; }
  .edge-line { fill: none; stroke: #94a3b8; stroke-width: 3; opacity: 0.6; transition: stroke 0.3s; }
  
  .node-box { cursor: pointer; transition: transform 0.2s; }
  .node-box:hover { transform: translate(0, -2px); }
  .node-box rect { fill: #2563eb; stroke: #60a5fa; stroke-width: 2; transition: all 0.3s; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
  .node-box text { fill: #fff; font-size: 14px; font-weight: 700; text-anchor: middle; pointer-events: none; letter-spacing: 0.5px; }
  .node-box:hover rect { fill: #3b82f6; stroke: #93c5fd; filter: drop-shadow(0 6px 8px rgba(0,0,0,0.4)); }

  .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.75); display: flex; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(4px); }
  .modal.hidden { display: none; }
  
  @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
  .modal-inner { 
    background: #1e293b; 
    color: #f1f5f9; 
    border-radius: 1rem; 
    width: min(900px, 95%); 
    max-height: 90vh; 
    overflow-y: auto; 
    padding: 2.5rem; 
    position: relative; 
    border: 1px solid #475569;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
    animation: modalIn 0.2s ease-out;
  }

  .close-btn { 
    position: absolute; top: 1.5rem; right: 1.5rem; 
    width: 2.5rem; height: 2.5rem; 
    border-radius: 50%; 
    border: 1px solid #475569; 
    background: #334155; 
    color: #cbd5e1; 
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.2s;
  }
  .close-btn:hover { background: #475569; color: #fff; border-color: #64748b; }
  
  .modal-inner h2 { text-align: center; font-size: 1.8rem; margin-bottom: 0.5rem; font-weight: 800; color: #fff; letter-spacing: -0.5px; }
  .count-text { text-align: center; color: #cbd5e1; margin-bottom: 1.5rem; font-variant-numeric: tabular-nums; font-size: 1.1rem; }
  
  .bar-track { height: 10px; background: #334155; border-radius: 5px; margin-bottom: 2rem; overflow: hidden; }
  .bar-fill { height: 100%; width: 0; background: #4ade80; border-radius: 5px; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
  
  .prereq-box { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem; justify-content: center; }
  .prereq-card { background: #334155; padding: 0.75rem 1.25rem; border-radius: 0.75rem; border: 1px solid #475569; font-size: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .prereq-card b { display: block; color: #60a5fa; margin-bottom: 0.25rem; }
  .prereq-card small { color: #cbd5e1; }
  
  .prob-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 1rem; }
  .prob-table th { text-align: left; padding: 1rem; color: #e2e8f0; font-weight: 700; border-bottom: 2px solid #475569; }
  .prob-table td { padding: 1rem; border-bottom: 1px solid #334155; color: #f1f5f9; }
  .prob-table tr:last-child td { border-bottom: none; }
  .prob-table tr:hover td { background: #334155; }
  
  .star { color: #94a3b8; width: 32px; }
  .star svg { width: 20px; height: 20px; }
  
  .prob-table a { color: #60a5fa; text-decoration: none; transition: color 0.2s; font-weight: 500; }
  .prob-table a:hover { color: #93c5fd; text-decoration: underline; }
  
  .diff { font-size: 0.85rem; font-weight: 700; padding: 0.3rem 0.8rem; border-radius: 9999px; display: inline-block; text-align: center; min-width: 80px; }
  .diff-easy { color: #22c55e; background: rgba(34, 197, 94, 0.15); border: 1px solid rgba(34, 197, 94, 0.2); }
  .diff-medium { color: #eab308; background: rgba(234, 179, 8, 0.15); border: 1px solid rgba(234, 179, 8, 0.2); }
  .diff-hard { color: #ef4444; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.2); }
  
  /* Custom Checkbox */
  input[type='checkbox'] {
    appearance: none;
    width: 1.5rem; height: 1.5rem;
    border: 2px solid #64748b;
    border-radius: 6px;
    background: #1e293b;
    cursor: pointer;
    position: relative;
    transition: all 0.2s;
  }
  input[type='checkbox']:checked {
    background: #22c55e;
    border-color: #22c55e;
  }
  input[type='checkbox']:checked::after {
    content: '';
    position: absolute;
    left: 6px; top: 2px;
    width: 6px; height: 12px;
    border: solid white;
    border-width: 0 3px 3px 0;
    transform: rotate(45deg);
  }
</style>
